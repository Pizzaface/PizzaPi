{"id":"PizzaPi-8d5","title":"Epic: multitenancy","description":"\n# Epic: Multitenancy\n\n## Overview\n\nIntroduce per-organization multitenancy to PizzaPi via a new **control plane** package (`packages/control-plane`) that manages orgs, centralized user identity, and JWT-based auth. Each org gets a dedicated PizzaPi server instance (separate process/container) with its own SQLite DB and Redis namespace. A reverse proxy (Caddy) handles subdomain-based routing. The existing `packages/server` is modified minimally — it gains JWT validation and org-context awareness but otherwise remains the single-org runtime it already is.\n\n## Architecture Decisions\n\n- **Separate control plane package**: The control plane is a new `packages/control-plane` Bun server, not bolted onto the existing server. This keeps concerns clean — the control plane manages identity and provisioning; org instances handle sessions and runners.\n- **JWT-based federated auth**: The control plane issues JWTs (via better-auth + custom JWT plugin). Org instances validate tokens using a shared JWKS endpoint — no direct DB sharing.\n- **Docker-based provisioning**: Org instances are provisioned as Docker containers via the Docker Engine API. Each container runs the existing `packages/server` with org-specific env vars (ORG_ID, ORG_SLUG, JWT_JWKS_URL, REDIS_PREFIX).\n- **Shared Redis with key prefixes**: A single Redis instance is used with per-org key prefixes (`org:{slug}:*`) to reduce infrastructure complexity. Dedicated Redis per org is a future option.\n- **Caddy reverse proxy**: Caddy with on-demand TLS and wildcard subdomain routing. Control plane registers/deregisters upstreams via Caddy's admin API.\n- **Minimal server changes**: The existing server gains a middleware that extracts org context from JWT and validates org membership. All existing routes remain unchanged — they're already scoped to a single instance's DB.\n\n## Technical Approach\n\n### Control Plane (`packages/control-plane`)\n\n- **Stack**: Bun.serve, Kysely + SQLite, better-auth\n- **Data model**:\n  - `organizations` (id, slug, name, status, created_at)\n  - `org_memberships` (user_id, org_id, role: owner|admin|member)\n  - `org_instances` (org_id, container_id, host, port, status, health_checked_at)\n  - Users table managed by better-auth\n- **API endpoints**:\n  - `POST /api/orgs` — create org + provision instance\n  - `GET/DELETE /api/orgs/:slug` — read/delete org\n  - `POST /api/orgs/:slug/members` — invite user\n  - `GET /api/orgs/:slug/status` — instance health\n  - `GET /api/user/orgs` — list orgs for authenticated user\n- **Provisioning**: Calls Docker Engine API to `docker run` a PizzaPi server container with org-specific config. Registers upstream with Caddy.\n- **Health checks**: Periodic HTTP health pings to org instances; marks unhealthy after 3 failures.\n\n### Server Modifications (`packages/server`)\n\n- **New middleware**: `org-context.ts` — extracts and validates JWT from `Authorization` header or cookie; populates `req.orgId` and `req.userId`. Falls back to existing better-auth session for backward compatibility (single-tenant mode).\n- **Env-based org config**: `ORG_ID`, `ORG_SLUG`, `REDIS_PREFIX`, `JWT_JWKS_URL` env vars. When `ORG_ID` is set, the server operates in multi-tenant mode.\n- **Redis namespacing**: Prefix all Redis keys with `REDIS_PREFIX` env var (defaults to empty for single-tenant).\n- **Runner auth**: Runners provide an org-scoped token during WebSocket handshake; server validates against its ORG_ID.\n\n### UI Changes (`packages/ui`)\n\n- **Org switcher**: Dropdown in the header showing user's orgs; switching navigates to `{slug}.pizzapi.example.com`.\n- **Control plane admin UI**: Separate route (`/admin`) on the control plane domain for org management (create, delete, view status). Simple table + forms — no complex dashboards in v1.\n- **Org settings page**: Within each org instance, a settings page for org-specific configuration (API keys, members list).\n\n### Infrastructure (`docker/`)\n\n- **Updated Docker Compose**: Adds `control-plane` and `caddy` services alongside existing `redis` and `server`.\n- **Caddy config**: Wildcard TLS, dynamic upstreams via admin API.\n- **Provisioning template**: A container template/config that the control plane uses to spin up org instances.\n\n### CLI Changes (`packages/cli`)\n\n- **Org-scoped runner registration**: `--org \u003cslug\u003e` flag; runner connects to `{slug}.pizzapi.example.com` and authenticates with an org-scoped token.\n\n## Implementation Strategy\n\n**Phase 1 — Foundation** (Tasks 1–4): Control plane package, data model, JWT auth, org CRUD API.\n**Phase 2 — Instance Management** (Tasks 5–7): Docker provisioning, Caddy routing, health checks.\n**Phase 3 — Integration** (Tasks 8–10): Server org-awareness, UI org switcher, CLI org flag, Docker Compose update.\n\nTesting approach: Unit tests for control plane API and JWT validation; integration tests for provisioning + routing; security tests for cross-org isolation.\n\n## Task Breakdown Preview\n\n- [ ] Task 1: Scaffold `packages/control-plane` with Bun server, Kysely, SQLite, better-auth\n- [ ] Task 2: Implement org data model and CRUD API (orgs, memberships, instances tables)\n- [ ] Task 3: Implement centralized JWT issuance (better-auth JWT plugin + JWKS endpoint)\n- [ ] Task 4: Add org-context JWT validation middleware to `packages/server`\n- [ ] Task 5: Implement Docker-based org instance provisioning in control plane\n- [ ] Task 6: Add Caddy reverse proxy config and dynamic upstream registration\n- [ ] Task 7: Implement instance health check loop in control plane\n- [ ] Task 8: Add Redis key-prefix namespacing to server and org-scoped runner auth\n- [ ] Task 9: Build UI org switcher, control plane admin page, and org settings page\n- [ ] Task 10: Update CLI for org-scoped runner registration and Docker Compose for full stack\n\n## Dependencies\n\n- **Docker Engine API** access from control plane container (Docker socket mount)\n- **Caddy** with admin API enabled for dynamic upstream management\n- **better-auth** JWT/JWKS capabilities (verify plugin support or implement custom)\n- **Wildcard DNS** configured in deployment environment\n\n## Success Criteria (Technical)\n\n- Control plane can create an org and have a healthy instance running within 60 seconds\n- JWT issued by control plane is validated by org instance with \u003c 50ms overhead\n- Zero cross-org data leakage verified by integration tests hitting multiple org subdomains\n- Single-tenant mode (no ORG_ID env var) works identically to current behavior — no regression\n- Docker Compose `up` brings up full multi-tenant stack (control plane + Caddy + Redis + sample org)\n\n## Estimated Effort\n\n- **Overall**: 3–4 weeks for a single developer\n- **Critical path**: Tasks 1–3 (control plane foundation) → Task 4 (server middleware) → Task 5–6 (provisioning + routing)\n- **Parallelizable**: Task 9 (UI) can proceed once Tasks 1–3 are done; Task 10 (CLI + Docker) can proceed alongside Task 9\n\n## Stats\n\nTotal tasks: 10\nParallel tasks: 7 (can be worked on simultaneously)\nSequential tasks: 3 (have dependencies)\nEstimated total effort: 58 hours\n","status":"open","priority":1,"issue_type":"epic","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:17:53Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:17:53Z","labels":["epic","epic:multitenancy","feature"]}
{"id":"PizzaPi-8d5.1","title":"Scaffold control-plane package","description":"\n# Task: Scaffold control-plane package\n\n## Description\n\nCreate `packages/control-plane` as a new Bun server package with the same foundational setup as `packages/server`: Bun.serve, Kysely + SQLite, better-auth, and TypeScript strict mode. This is the foundation all other control plane tasks build on.\n\n## Acceptance Criteria\n\n- [ ] `packages/control-plane/` exists with `package.json`, `tsconfig.json`, `src/index.ts`\n- [ ] Bun.serve starts and responds to health check at `GET /health`\n- [ ] Kysely is configured with SQLite (separate DB file: `control-plane.db`)\n- [ ] better-auth is initialized for user registration/login (email/password)\n- [ ] Package builds successfully with `bun run build`\n- [ ] Root `package.json` scripts updated to include control-plane in build/dev/typecheck\n\n## Technical Details\n\n- Mirror the structure of `packages/server/` for consistency\n- Use Kysely migrations for schema management\n- better-auth config: email/password provider, session management\n- Entry point: `src/index.ts` with Bun.serve\n- Port: configurable via `PORT` env var (default 3100)\n\n## Dependencies\n\n- [ ] None — this is the first task\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false — foundation for tasks 2-7\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:05Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:05Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.1","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:05Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.10","title":"CLI org flag and Docker Compose full stack","description":"\n# Task: CLI org flag and Docker Compose full stack\n\n## Description\n\nUpdate the CLI to support org-scoped runner registration and create a Docker Compose configuration that brings up the complete multi-tenant stack: control plane, Caddy, Redis, and a sample org instance.\n\n## Acceptance Criteria\n\n- [ ] `packages/cli` accepts `--org \u003cslug\u003e` flag for runner registration\n- [ ] When `--org` is provided, CLI connects to `{slug}.pizzapi.example.com` and authenticates with org-scoped JWT\n- [ ] CLI prompts for control plane login if no cached credentials\n- [ ] `docker/compose.multitenancy.yml` defines: control-plane, caddy, redis services on `pizzapi-net` network\n- [ ] `docker compose -f docker/compose.multitenancy.yml up` brings up a working multi-tenant stack\n- [ ] README section documenting multi-tenant deployment setup\n- [ ] Existing single-tenant `docker/compose.yml` is unaffected\n\n## Technical Details\n\n- CLI changes: add `--org` option to runner start command, fetch org-token from control plane before connecting\n- Docker Compose:\n  - `control-plane`: builds from `packages/control-plane`, exposes port 3100\n  - `caddy`: official Caddy image, mounts Caddyfile from `docker/Caddyfile`\n  - `redis`: existing redis service\n  - Shared network: `pizzapi-net`\n  - Volumes: `control-plane.db`, Caddy data/config\n- Separate compose file to avoid cluttering single-tenant setup\n\n## Dependencies\n\n- [ ] Task 004 — server JWT middleware\n- [ ] Task 005 — Docker provisioning\n- [ ] Task 006 — Caddy configuration\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: true — final integration task, but can start once dependencies are done\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:10Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:10Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:09Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5.4","type":"blocks","created_at":"2026-02-23T21:18:32Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5.5","type":"blocks","created_at":"2026-02-23T21:18:32Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5.6","type":"blocks","created_at":"2026-02-23T21:18:33Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.2","title":"Org data model and CRUD API","description":"\n# Task: Org data model and CRUD API\n\n## Description\n\nImplement the core data model (organizations, org_memberships, org_instances tables) and REST API endpoints for org management in the control plane.\n\n## Acceptance Criteria\n\n- [ ] Kysely migration creates `organizations`, `org_memberships`, and `org_instances` tables\n- [ ] `POST /api/orgs` creates an org (name, slug auto-generated from name)\n- [ ] `GET /api/orgs/:slug` returns org details\n- [ ] `DELETE /api/orgs/:slug` soft-deletes an org (owner only)\n- [ ] `POST /api/orgs/:slug/members` adds a user with role (owner/admin/member)\n- [ ] `GET /api/user/orgs` returns all orgs for the authenticated user\n- [ ] Slug uniqueness enforced at DB level\n- [ ] All endpoints require authentication\n\n## Technical Details\n\n- **Schema**:\n  - `organizations`: id (uuid), slug (unique), name, status (active/suspended/deleted), created_at, updated_at\n  - `org_memberships`: id, user_id (FK), org_id (FK), role (owner|admin|member), created_at\n  - `org_instances`: id, org_id (FK), container_id, host, port, status (provisioning|healthy|unhealthy|stopped), health_checked_at, created_at\n- Slug validation: lowercase alphanumeric + hyphens, 3-40 chars\n- Use better-auth session middleware for auth on all routes\n\n## Dependencies\n\n- [ ] Task 001 — control plane package scaffold\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false — needed by tasks 3, 5, 7\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:06Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:06Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.2","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:05Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.2","depends_on_id":"PizzaPi-8d5.1","type":"blocks","created_at":"2026-02-23T21:18:33Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.3","title":"JWT issuance and JWKS endpoint","description":"\n# Task: JWT issuance and JWKS endpoint\n\n## Description\n\nImplement centralized JWT token issuance on the control plane and a JWKS endpoint that org instances use to validate tokens. When a user authenticates and selects an org, the control plane issues a short-lived JWT containing user ID, org ID, and role.\n\n## Acceptance Criteria\n\n- [ ] Control plane generates RSA or Ed25519 key pair on first startup (stored in DB or file)\n- [ ] `POST /api/auth/org-token` accepts `{ orgSlug }` and returns a JWT with claims: `sub` (user_id), `org_id`, `org_slug`, `role`, `exp` (15 min)\n- [ ] `GET /.well-known/jwks.json` returns the public key in JWKS format\n- [ ] JWT is signed with the private key and verifiable with the JWKS public key\n- [ ] Token issuance requires an active better-auth session and valid org membership\n- [ ] Key rotation: support multiple keys in JWKS with `kid` field\n\n## Technical Details\n\n- Use `jose` npm package for JWT signing/verification and JWKS formatting\n- Key pair stored in `jwt_keys` table (id/kid, public_key, private_key, created_at, active)\n- On startup: check for active key, generate if none exists\n- JWT claims: `{ sub, org_id, org_slug, role, iat, exp, iss: \"pizzapi-control-plane\" }`\n- Token lifetime: 15 minutes (org instances cache JWKS for 5 minutes)\n\n## Dependencies\n\n- [ ] Task 001 — control plane scaffold\n- [ ] Task 002 — org data model (for membership validation)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false — critical path, needed by task 4\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:06Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:06Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.3","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:06Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.3","depends_on_id":"PizzaPi-8d5.1","type":"blocks","created_at":"2026-02-23T21:18:33Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.3","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-23T21:18:34Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.4","title":"Server org-context JWT middleware","description":"\n# Task: Server org-context JWT middleware\n\n## Description\n\nAdd a middleware to `packages/server` that validates JWTs issued by the control plane and populates org context on each request. When `ORG_ID` env var is set, the server operates in multi-tenant mode; otherwise it falls back to existing better-auth session auth (single-tenant backward compatibility).\n\n## Acceptance Criteria\n\n- [ ] New `src/middleware/org-context.ts` in packages/server\n- [ ] In multi-tenant mode: extracts JWT from `Authorization: Bearer \u003ctoken\u003e` header or `org_token` cookie\n- [ ] Validates JWT signature against JWKS fetched from `JWT_JWKS_URL` env var (cached 5 min)\n- [ ] Rejects requests with invalid/expired tokens (401)\n- [ ] Rejects requests where JWT `org_id` doesn't match server's `ORG_ID` (403)\n- [ ] Populates request context with `userId`, `orgId`, `orgSlug`, `role`\n- [ ] When `ORG_ID` is not set, middleware is a no-op (existing auth works unchanged)\n- [ ] All existing tests still pass (no regression)\n\n## Technical Details\n\n- Use `jose` package's `jwtVerify` with `createRemoteJWKSet`\n- JWKS URL: `JWT_JWKS_URL` env var (e.g., `https://control.pizzapi.example.com/.well-known/jwks.json`)\n- Cache JWKS in memory with 5-minute TTL\n- Integrate into existing middleware chain in `packages/server/src/middleware.ts`\n- Env vars: `ORG_ID`, `ORG_SLUG`, `JWT_JWKS_URL`\n\n## Dependencies\n\n- [ ] Task 003 — JWT issuance + JWKS endpoint\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: true — can run alongside tasks 5, 6, 7\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:07Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:07Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.4","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:06Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.4","depends_on_id":"PizzaPi-8d5.3","type":"blocks","created_at":"2026-02-23T21:18:34Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.5","title":"Docker-based org instance provisioning","description":"\n# Task: Docker-based org instance provisioning\n\n## Description\n\nImplement the provisioning engine in the control plane that creates and manages Docker containers for org instances. When an org is created, the control plane spins up a PizzaPi server container with org-specific configuration.\n\n## Acceptance Criteria\n\n- [ ] `POST /api/orgs` (from task 002) triggers automatic instance provisioning after org creation\n- [ ] Provisioner creates a Docker container using the PizzaPi server image with org-specific env vars\n- [ ] Env vars passed to container: `ORG_ID`, `ORG_SLUG`, `REDIS_PREFIX`, `JWT_JWKS_URL`, `PORT`\n- [ ] Container is attached to a shared Docker network for inter-service communication\n- [ ] `org_instances` table updated with container_id, host, port, status\n- [ ] `DELETE /api/orgs/:slug` stops and removes the container\n- [ ] Provisioning errors are caught and reported (org status set to \"error\")\n- [ ] Configurable Docker image name via `PIZZAPI_SERVER_IMAGE` env var\n\n## Technical Details\n\n- Use `dockerode` npm package to interact with Docker Engine API\n- Docker socket mounted into control plane container (`/var/run/docker.sock`)\n- Each org container gets a unique port (auto-assigned or from a port range)\n- Container naming: `pizzapi-org-{slug}`\n- Network: `pizzapi-net` (created if not exists)\n- Container labels for identification: `pizzapi.org={slug}`, `pizzapi.type=org-instance`\n\n## Dependencies\n\n- [ ] Task 002 — org data model and CRUD API\n\n## Effort Estimate\n\n- Size: L\n- Hours: 8\n- Parallel: true — can run alongside tasks 4, 6\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:07Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:07Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.5","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:07Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.5","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-23T21:18:35Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.6","title":"Caddy reverse proxy and subdomain routing","description":"\n# Task: Caddy reverse proxy and subdomain routing\n\n## Description\n\nConfigure Caddy as the reverse proxy for subdomain-based routing. The control plane dynamically registers/deregisters upstream backends via Caddy's admin API when org instances are provisioned or removed.\n\n## Acceptance Criteria\n\n- [ ] Caddy configuration with wildcard domain (`*.pizzapi.example.com`)\n- [ ] Control plane domain routes to control plane service (`control.pizzapi.example.com` or root domain)\n- [ ] Org subdomains route to the correct org instance container\n- [ ] Control plane registers upstream with Caddy admin API after container provisioning\n- [ ] Control plane removes upstream on org deletion\n- [ ] WebSocket connections (`/ws`) are correctly proxied\n- [ ] Health check endpoint (`/health`) accessible on each subdomain\n- [ ] Caddyfile or JSON config template included in `docker/`\n\n## Technical Details\n\n- Caddy admin API: `POST /config/apps/http/servers/...` to add/update routes\n- Alternative: use Caddy's `on_demand_tls` with a validation endpoint on the control plane\n- Control plane implements `GET /api/caddy/validate?domain={slug}.pizzapi.example.com` returning 200 for valid orgs\n- Caddy config in `docker/Caddyfile` with `reverse_proxy` and dynamic upstreams\n- WebSocket proxy: ensure `Connection: Upgrade` headers are forwarded\n\n## Dependencies\n\n- [ ] Task 005 — Docker provisioning (need running containers to route to)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 5\n- Parallel: true — can run alongside task 4\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:08Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:08Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.6","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:07Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.6","depends_on_id":"PizzaPi-8d5.5","type":"blocks","created_at":"2026-02-23T21:18:35Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.7","title":"Instance health check loop","description":"\n# Task: Instance health check loop\n\n## Description\n\nImplement a periodic health check in the control plane that pings all org instances and updates their status. Unhealthy instances are flagged after 3 consecutive failures.\n\n## Acceptance Criteria\n\n- [ ] Background loop runs every 30 seconds (configurable via `HEALTH_CHECK_INTERVAL_MS`)\n- [ ] Pings `GET /health` on each org instance's internal host:port\n- [ ] Updates `org_instances.status` to \"healthy\" or \"unhealthy\"\n- [ ] Updates `org_instances.health_checked_at` timestamp\n- [ ] After 3 consecutive failures, marks instance as \"unhealthy\"\n- [ ] `GET /api/orgs/:slug/status` returns instance health info\n- [ ] Health check timeout: 5 seconds per instance\n- [ ] Logs warnings for unhealthy instances\n\n## Technical Details\n\n- Use `fetch()` with AbortSignal timeout for health pings\n- Track consecutive failure count in memory (Map\u003corgId, failCount\u003e)\n- Run as `setInterval` in the control plane process\n- Skip instances with status \"stopped\" or \"provisioning\"\n\n## Dependencies\n\n- [ ] Task 002 — org_instances table\n- [ ] Task 005 — provisioned instances to check\n\n## Effort Estimate\n\n- Size: S\n- Hours: 3\n- Parallel: true — independent background service\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:08Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:08Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.7","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:08Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.7","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-23T21:18:36Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.7","depends_on_id":"PizzaPi-8d5.5","type":"blocks","created_at":"2026-02-23T21:18:36Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.8","title":"Redis namespacing and org-scoped runner auth","description":"\n# Task: Redis namespacing and org-scoped runner auth\n\n## Description\n\nUpdate the server's Redis usage to prefix all keys with an org-specific namespace. Update runner WebSocket authentication to validate org-scoped tokens.\n\n## Acceptance Criteria\n\n- [ ] All Redis `get`/`set`/`pub`/`sub` calls in packages/server use `REDIS_PREFIX` env var as key prefix\n- [ ] When `REDIS_PREFIX` is empty or unset, keys are unchanged (backward compatible)\n- [ ] Runner WebSocket handshake accepts org-scoped JWT token (same format as user JWT but with `type: \"runner\"`)\n- [ ] Runner connections are rejected if JWT `org_id` doesn't match server's `ORG_ID`\n- [ ] Existing single-tenant runner auth still works when `ORG_ID` is unset\n- [ ] No cross-org key collisions when multiple instances share one Redis\n\n## Technical Details\n\n- Create a Redis key helper: `const key = (k: string) =\u003e prefix ? \\`${prefix}:${k}\\` : k`\n- Apply to all Redis operations in `packages/server/src/sessions/` and `packages/server/src/ws/`\n- Runner auth: extract token from WebSocket URL query param `?token=\u003cjwt\u003e` or first message\n- Prefix format: `org:{slug}:` (e.g., `org:acme:session:123`)\n\n## Dependencies\n\n- [ ] Task 004 — JWT middleware (for token validation logic)\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: true — can run alongside tasks 5, 6, 9\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:09Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:09Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.8","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:08Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.8","depends_on_id":"PizzaPi-8d5.4","type":"blocks","created_at":"2026-02-23T21:18:37Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-8d5.9","title":"UI org switcher and admin pages","description":"\n# Task: UI org switcher and admin pages\n\n## Description\n\nBuild the UI components for multitenancy: an org switcher in the main app header, a control plane admin page for managing orgs, and an org settings page within each instance.\n\n## Acceptance Criteria\n\n- [ ] **Org switcher** dropdown in app header showing user's orgs (fetched from control plane `/api/user/orgs`)\n- [ ] Selecting an org navigates to `{slug}.pizzapi.example.com`\n- [ ] Current org is visually highlighted in the switcher\n- [ ] **Admin page** (`/admin` on control plane domain): list all orgs, create new org, delete org, view health status\n- [ ] **Org settings page** (`/settings/org` on org instance): view org info, manage members (list, invite, remove), view connected runners\n- [ ] All pages are responsive and follow existing shadcn/ui design patterns\n- [ ] Loading and error states handled for all API calls\n\n## Technical Details\n\n- Org switcher: Radix UI `DropdownMenu` component, placed in existing header/nav\n- Admin page: new route in UI, only rendered when on control plane domain (detect via `window.location`)\n- Org settings: new route in existing org instance UI\n- API calls: use existing fetch utilities, point to control plane URL for org data\n- Control plane URL stored in env var `VITE_CONTROL_PLANE_URL`\n\n## Dependencies\n\n- [ ] Task 002 — org CRUD API endpoints\n- [ ] Task 003 — JWT auth (for authenticating cross-origin requests to control plane)\n\n## Effort Estimate\n\n- Size: L\n- Hours: 10\n- Parallel: true — can run alongside tasks 4, 5, 6, 7, 8\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:09Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:09Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.9","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-23T21:18:09Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.9","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-23T21:18:37Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-8d5.9","depends_on_id":"PizzaPi-8d5.3","type":"blocks","created_at":"2026-02-23T21:18:37Z","created_by":"Jordan Pizza","metadata":"{}"}]}
