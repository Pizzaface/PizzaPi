{"id":"PizzaPi-8d5","title":"Epic: multitenancy","description":"\n# Epic: Multitenancy\n\n## Overview\n\nIntroduce per-organization multitenancy to PizzaPi via a new **control plane** package (`packages/control-plane`) that manages orgs, centralized user identity, and JWT-based auth. Each org gets a dedicated PizzaPi server instance (separate process/container) with its own SQLite DB and Redis namespace. A reverse proxy (Caddy) handles subdomain-based routing. The existing `packages/server` is modified minimally — it gains JWT validation and org-context awareness but otherwise remains the single-org runtime it already is.\n\n## Architecture Decisions\n\n- **Separate control plane package**: The control plane is a new `packages/control-plane` Bun server, not bolted onto the existing server. This keeps concerns clean — the control plane manages identity and provisioning; org instances handle sessions and runners.\n- **JWT-based federated auth**: The control plane issues JWTs (via better-auth + custom JWT plugin). Org instances validate tokens using a shared JWKS endpoint — no direct DB sharing.\n- **Docker-based provisioning**: Org instances are provisioned as Docker containers via the Docker Engine API. Each container runs the existing `packages/server` with org-specific env vars (ORG_ID, ORG_SLUG, JWT_JWKS_URL, REDIS_PREFIX).\n- **Shared Redis with key prefixes**: A single Redis instance is used with per-org key prefixes (`org:{slug}:*`) to reduce infrastructure complexity. Dedicated Redis per org is a future option.\n- **Caddy reverse proxy**: Caddy with on-demand TLS and wildcard subdomain routing. Control plane registers/deregisters upstreams via Caddy's admin API.\n- **Minimal server changes**: The existing server gains a middleware that extracts org context from JWT and validates org membership. All existing routes remain unchanged — they're already scoped to a single instance's DB.\n\n## Technical Approach\n\n### Control Plane (`packages/control-plane`)\n\n- **Stack**: Bun.serve, Kysely + SQLite, better-auth\n- **Data model**:\n  - `organizations` (id, slug, name, status, created_at)\n  - `org_memberships` (user_id, org_id, role: owner|admin|member)\n  - `org_instances` (org_id, container_id, host, port, status, health_checked_at)\n  - Users table managed by better-auth\n- **API endpoints**:\n  - `POST /api/orgs` — create org + provision instance\n  - `GET/DELETE /api/orgs/:slug` — read/delete org\n  - `POST /api/orgs/:slug/members` — invite user\n  - `GET /api/orgs/:slug/status` — instance health\n  - `GET /api/user/orgs` — list orgs for authenticated user\n- **Provisioning**: Calls Docker Engine API to `docker run` a PizzaPi server container with org-specific config. Registers upstream with Caddy.\n- **Health checks**: Periodic HTTP health pings to org instances; marks unhealthy after 3 failures.\n\n### Server Modifications (`packages/server`)\n\n- **New middleware**: `org-context.ts` — extracts and validates JWT from `Authorization` header or cookie; populates `req.orgId` and `req.userId`. Falls back to existing better-auth session for backward compatibility (single-tenant mode).\n- **Env-based org config**: `ORG_ID`, `ORG_SLUG`, `REDIS_PREFIX`, `JWT_JWKS_URL` env vars. When `ORG_ID` is set, the server operates in multi-tenant mode.\n- **Redis namespacing**: Prefix all Redis keys with `REDIS_PREFIX` env var (defaults to empty for single-tenant).\n- **Runner auth**: Runners provide an org-scoped token during WebSocket handshake; server validates against its ORG_ID.\n\n### UI Changes (`packages/ui`)\n\n- **Org switcher**: Dropdown in the header showing user's orgs; switching navigates to `{slug}.pizzapi.example.com`.\n- **Control plane admin UI**: Separate route (`/admin`) on the control plane domain for org management (create, delete, view status). Simple table + forms — no complex dashboards in v1.\n- **Org settings page**: Within each org instance, a settings page for org-specific configuration (API keys, members list).\n\n### Infrastructure (`docker/`)\n\n- **Updated Docker Compose**: Adds `control-plane` and `caddy` services alongside existing `redis` and `server`.\n- **Caddy config**: Wildcard TLS, dynamic upstreams via admin API.\n- **Provisioning template**: A container template/config that the control plane uses to spin up org instances.\n\n### CLI Changes (`packages/cli`)\n\n- **Org-scoped runner registration**: `--org \u003cslug\u003e` flag; runner connects to `{slug}.pizzapi.example.com` and authenticates with an org-scoped token.\n\n## Implementation Strategy\n\n**Phase 1 — Foundation** (Tasks 1–4): Control plane package, data model, JWT auth, org CRUD API.\n**Phase 2 — Instance Management** (Tasks 5–7): Docker provisioning, Caddy routing, health checks.\n**Phase 3 — Integration** (Tasks 8–10): Server org-awareness, UI org switcher, CLI org flag, Docker Compose update.\n\nTesting approach: Unit tests for control plane API and JWT validation; integration tests for provisioning + routing; security tests for cross-org isolation.\n\n## Task Breakdown Preview\n\n- [ ] Task 1: Scaffold `packages/control-plane` with Bun server, Kysely, SQLite, better-auth\n- [ ] Task 2: Implement org data model and CRUD API (orgs, memberships, instances tables)\n- [ ] Task 3: Implement centralized JWT issuance (better-auth JWT plugin + JWKS endpoint)\n- [ ] Task 4: Add org-context JWT validation middleware to `packages/server`\n- [ ] Task 5: Implement Docker-based org instance provisioning in control plane\n- [ ] Task 6: Add Caddy reverse proxy config and dynamic upstream registration\n- [ ] Task 7: Implement instance health check loop in control plane\n- [ ] Task 8: Add Redis key-prefix namespacing to server and org-scoped runner auth\n- [ ] Task 9: Build UI org switcher, control plane admin page, and org settings page\n- [ ] Task 10: Update CLI for org-scoped runner registration and Docker Compose for full stack\n\n## Dependencies\n\n- **Docker Engine API** access from control plane container (Docker socket mount)\n- **Caddy** with admin API enabled for dynamic upstream management\n- **better-auth** JWT/JWKS capabilities (verify plugin support or implement custom)\n- **Wildcard DNS** configured in deployment environment\n\n## Success Criteria (Technical)\n\n- Control plane can create an org and have a healthy instance running within 60 seconds\n- JWT issued by control plane is validated by org instance with \u003c 50ms overhead\n- Zero cross-org data leakage verified by integration tests hitting multiple org subdomains\n- Single-tenant mode (no ORG_ID env var) works identically to current behavior — no regression\n- Docker Compose `up` brings up full multi-tenant stack (control plane + Caddy + Redis + sample org)\n\n## Estimated Effort\n\n- **Overall**: 3–4 weeks for a single developer\n- **Critical path**: Tasks 1–3 (control plane foundation) → Task 4 (server middleware) → Task 5–6 (provisioning + routing)\n- **Parallelizable**: Task 9 (UI) can proceed once Tasks 1–3 are done; Task 10 (CLI + Docker) can proceed alongside Task 9\n\n## Stats\n\nTotal tasks: 10\nParallel tasks: 7 (can be worked on simultaneously)\nSequential tasks: 3 (have dependencies)\nEstimated total effort: 58 hours\n","status":"open","priority":1,"issue_type":"epic","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:17:53Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:17:53Z","labels":["epic","epic:multitenancy","feature"]}
{"id":"PizzaPi-8d5.1","title":"Scaffold control-plane package","description":"\n# Task: Scaffold control-plane package\n\n## Description\n\nCreate `packages/control-plane` as a new Bun server package with the same foundational setup as `packages/server`: Bun.serve, Kysely + SQLite, better-auth, and TypeScript strict mode. This is the foundation all other control plane tasks build on.\n\n## Acceptance Criteria\n\n- [ ] `packages/control-plane/` exists with `package.json`, `tsconfig.json`, `src/index.ts`\n- [ ] Bun.serve starts and responds to health check at `GET /health`\n- [ ] Kysely is configured with SQLite (separate DB file: `control-plane.db`)\n- [ ] better-auth is initialized for user registration/login (email/password)\n- [ ] Package builds successfully with `bun run build`\n- [ ] Root `package.json` scripts updated to include control-plane in build/dev/typecheck\n\n## Technical Details\n\n- Mirror the structure of `packages/server/` for consistency\n- Use Kysely migrations for schema management\n- better-auth config: email/password provider, session management\n- Entry point: `src/index.ts` with Bun.serve\n- Port: configurable via `PORT` env var (default 3100)\n\n## Dependencies\n\n- [ ] None — this is the first task\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false — foundation for tasks 2-7\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:05Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:05Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.1","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.10","title":"CLI org flag and Docker Compose full stack","description":"\n# Task: CLI org flag and Docker Compose full stack\n\n## Description\n\nUpdate the CLI to support org-scoped runner registration and create a Docker Compose configuration that brings up the complete multi-tenant stack: control plane, Caddy, Redis, and a sample org instance.\n\n## Acceptance Criteria\n\n- [ ] `packages/cli` accepts `--org \u003cslug\u003e` flag for runner registration\n- [ ] When `--org` is provided, CLI connects to `{slug}.pizzapi.example.com` and authenticates with org-scoped JWT\n- [ ] CLI prompts for control plane login if no cached credentials\n- [ ] `docker/compose.multitenancy.yml` defines: control-plane, caddy, redis services on `pizzapi-net` network\n- [ ] `docker compose -f docker/compose.multitenancy.yml up` brings up a working multi-tenant stack\n- [ ] README section documenting multi-tenant deployment setup\n- [ ] Existing single-tenant `docker/compose.yml` is unaffected\n\n## Technical Details\n\n- CLI changes: add `--org` option to runner start command, fetch org-token from control plane before connecting\n- Docker Compose:\n  - `control-plane`: builds from `packages/control-plane`, exposes port 3100\n  - `caddy`: official Caddy image, mounts Caddyfile from `docker/Caddyfile`\n  - `redis`: existing redis service\n  - Shared network: `pizzapi-net`\n  - Volumes: `control-plane.db`, Caddy data/config\n- Separate compose file to avoid cluttering single-tenant setup\n\n## Dependencies\n\n- [ ] Task 004 — server JWT middleware\n- [ ] Task 005 — Docker provisioning\n- [ ] Task 006 — Caddy configuration\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: true — final integration task, but can start once dependencies are done\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:10Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:10Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5.4","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5.5","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.10","depends_on_id":"PizzaPi-8d5.6","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.2","title":"Org data model and CRUD API","description":"\n# Task: Org data model and CRUD API\n\n## Description\n\nImplement the core data model (organizations, org_memberships, org_instances tables) and REST API endpoints for org management in the control plane.\n\n## Acceptance Criteria\n\n- [ ] Kysely migration creates `organizations`, `org_memberships`, and `org_instances` tables\n- [ ] `POST /api/orgs` creates an org (name, slug auto-generated from name)\n- [ ] `GET /api/orgs/:slug` returns org details\n- [ ] `DELETE /api/orgs/:slug` soft-deletes an org (owner only)\n- [ ] `POST /api/orgs/:slug/members` adds a user with role (owner/admin/member)\n- [ ] `GET /api/user/orgs` returns all orgs for the authenticated user\n- [ ] Slug uniqueness enforced at DB level\n- [ ] All endpoints require authentication\n\n## Technical Details\n\n- **Schema**:\n  - `organizations`: id (uuid), slug (unique), name, status (active/suspended/deleted), created_at, updated_at\n  - `org_memberships`: id, user_id (FK), org_id (FK), role (owner|admin|member), created_at\n  - `org_instances`: id, org_id (FK), container_id, host, port, status (provisioning|healthy|unhealthy|stopped), health_checked_at, created_at\n- Slug validation: lowercase alphanumeric + hyphens, 3-40 chars\n- Use better-auth session middleware for auth on all routes\n\n## Dependencies\n\n- [ ] Task 001 — control plane package scaffold\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false — needed by tasks 3, 5, 7\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:06Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:06Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.2","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.2","depends_on_id":"PizzaPi-8d5.1","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.3","title":"JWT issuance and JWKS endpoint","description":"\n# Task: JWT issuance and JWKS endpoint\n\n## Description\n\nImplement centralized JWT token issuance on the control plane and a JWKS endpoint that org instances use to validate tokens. When a user authenticates and selects an org, the control plane issues a short-lived JWT containing user ID, org ID, and role.\n\n## Acceptance Criteria\n\n- [ ] Control plane generates RSA or Ed25519 key pair on first startup (stored in DB or file)\n- [ ] `POST /api/auth/org-token` accepts `{ orgSlug }` and returns a JWT with claims: `sub` (user_id), `org_id`, `org_slug`, `role`, `exp` (15 min)\n- [ ] `GET /.well-known/jwks.json` returns the public key in JWKS format\n- [ ] JWT is signed with the private key and verifiable with the JWKS public key\n- [ ] Token issuance requires an active better-auth session and valid org membership\n- [ ] Key rotation: support multiple keys in JWKS with `kid` field\n\n## Technical Details\n\n- Use `jose` npm package for JWT signing/verification and JWKS formatting\n- Key pair stored in `jwt_keys` table (id/kid, public_key, private_key, created_at, active)\n- On startup: check for active key, generate if none exists\n- JWT claims: `{ sub, org_id, org_slug, role, iat, exp, iss: \"pizzapi-control-plane\" }`\n- Token lifetime: 15 minutes (org instances cache JWKS for 5 minutes)\n\n## Dependencies\n\n- [ ] Task 001 — control plane scaffold\n- [ ] Task 002 — org data model (for membership validation)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false — critical path, needed by task 4\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:06Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:06Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.3","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.3","depends_on_id":"PizzaPi-8d5.1","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.3","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.4","title":"Server org-context JWT middleware","description":"\n# Task: Server org-context JWT middleware\n\n## Description\n\nAdd a middleware to `packages/server` that validates JWTs issued by the control plane and populates org context on each request. When `ORG_ID` env var is set, the server operates in multi-tenant mode; otherwise it falls back to existing better-auth session auth (single-tenant backward compatibility).\n\n## Acceptance Criteria\n\n- [ ] New `src/middleware/org-context.ts` in packages/server\n- [ ] In multi-tenant mode: extracts JWT from `Authorization: Bearer \u003ctoken\u003e` header or `org_token` cookie\n- [ ] Validates JWT signature against JWKS fetched from `JWT_JWKS_URL` env var (cached 5 min)\n- [ ] Rejects requests with invalid/expired tokens (401)\n- [ ] Rejects requests where JWT `org_id` doesn't match server's `ORG_ID` (403)\n- [ ] Populates request context with `userId`, `orgId`, `orgSlug`, `role`\n- [ ] When `ORG_ID` is not set, middleware is a no-op (existing auth works unchanged)\n- [ ] All existing tests still pass (no regression)\n\n## Technical Details\n\n- Use `jose` package's `jwtVerify` with `createRemoteJWKSet`\n- JWKS URL: `JWT_JWKS_URL` env var (e.g., `https://control.pizzapi.example.com/.well-known/jwks.json`)\n- Cache JWKS in memory with 5-minute TTL\n- Integrate into existing middleware chain in `packages/server/src/middleware.ts`\n- Env vars: `ORG_ID`, `ORG_SLUG`, `JWT_JWKS_URL`\n\n## Dependencies\n\n- [ ] Task 003 — JWT issuance + JWKS endpoint\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: true — can run alongside tasks 5, 6, 7\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:07Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:07Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.4","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.4","depends_on_id":"PizzaPi-8d5.3","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.5","title":"Docker-based org instance provisioning","description":"\n# Task: Docker-based org instance provisioning\n\n## Description\n\nImplement the provisioning engine in the control plane that creates and manages Docker containers for org instances. When an org is created, the control plane spins up a PizzaPi server container with org-specific configuration.\n\n## Acceptance Criteria\n\n- [ ] `POST /api/orgs` (from task 002) triggers automatic instance provisioning after org creation\n- [ ] Provisioner creates a Docker container using the PizzaPi server image with org-specific env vars\n- [ ] Env vars passed to container: `ORG_ID`, `ORG_SLUG`, `REDIS_PREFIX`, `JWT_JWKS_URL`, `PORT`\n- [ ] Container is attached to a shared Docker network for inter-service communication\n- [ ] `org_instances` table updated with container_id, host, port, status\n- [ ] `DELETE /api/orgs/:slug` stops and removes the container\n- [ ] Provisioning errors are caught and reported (org status set to \"error\")\n- [ ] Configurable Docker image name via `PIZZAPI_SERVER_IMAGE` env var\n\n## Technical Details\n\n- Use `dockerode` npm package to interact with Docker Engine API\n- Docker socket mounted into control plane container (`/var/run/docker.sock`)\n- Each org container gets a unique port (auto-assigned or from a port range)\n- Container naming: `pizzapi-org-{slug}`\n- Network: `pizzapi-net` (created if not exists)\n- Container labels for identification: `pizzapi.org={slug}`, `pizzapi.type=org-instance`\n\n## Dependencies\n\n- [ ] Task 002 — org data model and CRUD API\n\n## Effort Estimate\n\n- Size: L\n- Hours: 8\n- Parallel: true — can run alongside tasks 4, 6\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:07Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:07Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.5","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.5","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.6","title":"Caddy reverse proxy and subdomain routing","description":"\n# Task: Caddy reverse proxy and subdomain routing\n\n## Description\n\nConfigure Caddy as the reverse proxy for subdomain-based routing. The control plane dynamically registers/deregisters upstream backends via Caddy's admin API when org instances are provisioned or removed.\n\n## Acceptance Criteria\n\n- [ ] Caddy configuration with wildcard domain (`*.pizzapi.example.com`)\n- [ ] Control plane domain routes to control plane service (`control.pizzapi.example.com` or root domain)\n- [ ] Org subdomains route to the correct org instance container\n- [ ] Control plane registers upstream with Caddy admin API after container provisioning\n- [ ] Control plane removes upstream on org deletion\n- [ ] WebSocket connections (`/ws`) are correctly proxied\n- [ ] Health check endpoint (`/health`) accessible on each subdomain\n- [ ] Caddyfile or JSON config template included in `docker/`\n\n## Technical Details\n\n- Caddy admin API: `POST /config/apps/http/servers/...` to add/update routes\n- Alternative: use Caddy's `on_demand_tls` with a validation endpoint on the control plane\n- Control plane implements `GET /api/caddy/validate?domain={slug}.pizzapi.example.com` returning 200 for valid orgs\n- Caddy config in `docker/Caddyfile` with `reverse_proxy` and dynamic upstreams\n- WebSocket proxy: ensure `Connection: Upgrade` headers are forwarded\n\n## Dependencies\n\n- [ ] Task 005 — Docker provisioning (need running containers to route to)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 5\n- Parallel: true — can run alongside task 4\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:08Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:08Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.6","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.6","depends_on_id":"PizzaPi-8d5.5","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.7","title":"Instance health check loop","description":"\n# Task: Instance health check loop\n\n## Description\n\nImplement a periodic health check in the control plane that pings all org instances and updates their status. Unhealthy instances are flagged after 3 consecutive failures.\n\n## Acceptance Criteria\n\n- [ ] Background loop runs every 30 seconds (configurable via `HEALTH_CHECK_INTERVAL_MS`)\n- [ ] Pings `GET /health` on each org instance's internal host:port\n- [ ] Updates `org_instances.status` to \"healthy\" or \"unhealthy\"\n- [ ] Updates `org_instances.health_checked_at` timestamp\n- [ ] After 3 consecutive failures, marks instance as \"unhealthy\"\n- [ ] `GET /api/orgs/:slug/status` returns instance health info\n- [ ] Health check timeout: 5 seconds per instance\n- [ ] Logs warnings for unhealthy instances\n\n## Technical Details\n\n- Use `fetch()` with AbortSignal timeout for health pings\n- Track consecutive failure count in memory (Map\u003corgId, failCount\u003e)\n- Run as `setInterval` in the control plane process\n- Skip instances with status \"stopped\" or \"provisioning\"\n\n## Dependencies\n\n- [ ] Task 002 — org_instances table\n- [ ] Task 005 — provisioned instances to check\n\n## Effort Estimate\n\n- Size: S\n- Hours: 3\n- Parallel: true — independent background service\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:08Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:08Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.7","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.7","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.7","depends_on_id":"PizzaPi-8d5.5","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.8","title":"Redis namespacing and org-scoped runner auth","description":"\n# Task: Redis namespacing and org-scoped runner auth\n\n## Description\n\nUpdate the server's Redis usage to prefix all keys with an org-specific namespace. Update runner WebSocket authentication to validate org-scoped tokens.\n\n## Acceptance Criteria\n\n- [ ] All Redis `get`/`set`/`pub`/`sub` calls in packages/server use `REDIS_PREFIX` env var as key prefix\n- [ ] When `REDIS_PREFIX` is empty or unset, keys are unchanged (backward compatible)\n- [ ] Runner WebSocket handshake accepts org-scoped JWT token (same format as user JWT but with `type: \"runner\"`)\n- [ ] Runner connections are rejected if JWT `org_id` doesn't match server's `ORG_ID`\n- [ ] Existing single-tenant runner auth still works when `ORG_ID` is unset\n- [ ] No cross-org key collisions when multiple instances share one Redis\n\n## Technical Details\n\n- Create a Redis key helper: `const key = (k: string) =\u003e prefix ? \\`${prefix}:${k}\\` : k`\n- Apply to all Redis operations in `packages/server/src/sessions/` and `packages/server/src/ws/`\n- Runner auth: extract token from WebSocket URL query param `?token=\u003cjwt\u003e` or first message\n- Prefix format: `org:{slug}:` (e.g., `org:acme:session:123`)\n\n## Dependencies\n\n- [ ] Task 004 — JWT middleware (for token validation logic)\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: true — can run alongside tasks 5, 6, 9\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:09Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:09Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.8","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.8","depends_on_id":"PizzaPi-8d5.4","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-8d5.9","title":"UI org switcher and admin pages","description":"\n# Task: UI org switcher and admin pages\n\n## Description\n\nBuild the UI components for multitenancy: an org switcher in the main app header, a control plane admin page for managing orgs, and an org settings page within each instance.\n\n## Acceptance Criteria\n\n- [ ] **Org switcher** dropdown in app header showing user's orgs (fetched from control plane `/api/user/orgs`)\n- [ ] Selecting an org navigates to `{slug}.pizzapi.example.com`\n- [ ] Current org is visually highlighted in the switcher\n- [ ] **Admin page** (`/admin` on control plane domain): list all orgs, create new org, delete org, view health status\n- [ ] **Org settings page** (`/settings/org` on org instance): view org info, manage members (list, invite, remove), view connected runners\n- [ ] All pages are responsive and follow existing shadcn/ui design patterns\n- [ ] Loading and error states handled for all API calls\n\n## Technical Details\n\n- Org switcher: Radix UI `DropdownMenu` component, placed in existing header/nav\n- Admin page: new route in UI, only rendered when on control plane domain (detect via `window.location`)\n- Org settings: new route in existing org instance UI\n- API calls: use existing fetch utilities, point to control plane URL for org data\n- Control plane URL stored in env var `VITE_CONTROL_PLANE_URL`\n\n## Dependencies\n\n- [ ] Task 002 — org CRUD API endpoints\n- [ ] Task 003 — JWT auth (for authenticating cross-origin requests to control plane)\n\n## Effort Estimate\n\n- Size: L\n- Hours: 10\n- Parallel: true — can run alongside tasks 4, 5, 6, 7, 8\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T02:18:09Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T02:18:09Z","labels":["epic:multitenancy","task"],"dependencies":[{"issue_id":"PizzaPi-8d5.9","depends_on_id":"PizzaPi-8d5","type":"parent-child","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.9","depends_on_id":"PizzaPi-8d5.2","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"},{"issue_id":"PizzaPi-8d5.9","depends_on_id":"PizzaPi-8d5.3","type":"blocks","created_at":"2026-02-24T17:56:23Z","created_by":"bootstrap","metadata":"{}"}]}
{"id":"PizzaPi-rc3","title":"Epic: at-file-mentions","description":"\n# Epic: at-file-mentions\n\n## Overview\n\nAdd an `@` file-mention system to the `SessionViewer` prompt input. When a user types `@` (at word boundary), a popover appears showing files and directories from the connected runner's CWD via the existing `/api/runners/{id}/files` API. Users can drill into folders and select a file to insert its relative path as `@path/to/file.tsx` into the message. The UI follows the existing slash-command Command popover pattern in `SessionViewer.tsx`.\n\nNo backend changes are required — the `/api/runners/{id}/files` API already supports arbitrary path listing.\n\n## Architecture Decisions\n\n- **Reuse Command popover pattern**: The `@` mention popover sits alongside the existing slash-command `Command` popover in `SessionViewer.tsx`. They are mutually exclusive (`commandOpen` vs `atMentionOpen`).\n- **New `AtMentionPopover` component**: Extract the mention UI into a self-contained component in `packages/ui/src/components/AtMentionPopover.tsx` to keep `SessionViewer.tsx` readable.\n- **`useAtMentionFiles` hook**: Encapsulate fetch logic and per-session path-keyed cache (a `Map\u003cpath, entries\u003e`) in a custom hook. Cache lives only for the duration of the popover being open; invalidated on close.\n- **Prop threading**: `runnerId` is already present in `activeSessionInfo` in `App.tsx` and needs to be added to `SessionViewerProps` so `SessionViewer` can call the files API. App.tsx already passes it to `FileExplorer`; parity is straightforward.\n- **Text replacement**: Track the `@` trigger cursor offset in the input string. On selection, replace the substring from `@` to cursor with `@relative/path ` using standard string manipulation.\n- **No rich-text editor**: Paths are inserted as plain text into the `\u003ctextarea\u003e`. Syntax highlighting of `@tokens` is out of scope for this epic.\n\n## Technical Approach\n\n### Frontend Components\n\n**`packages/ui/src/components/AtMentionPopover.tsx`** (new)\n- Renders the `Command`/`CommandList` popover (shadcn) with file/folder entries\n- Props: `open`, `runnerId`, `path`, `query`, `onSelectFile(path)`, `onDrillInto(path)`, `onClose`\n- Shows breadcrumb header with current path and \"← Back\" action\n- Reuses file/folder icons from `FileExplorer` (`FileIcon`, `FolderIcon`)\n- Sorts: directories first (alphabetical), then files (alphabetical)\n- Hides dot-files/folders (`name.startsWith('.')`)\n- Loading and empty states handled internally via `useAtMentionFiles`\n\n**`packages/ui/src/hooks/useAtMentionFiles.ts`** (new)\n- Accepts `runnerId: string | undefined`, `path: string`, `enabled: boolean`\n- Returns `{ entries, loading, error }`\n- Caches fetched listings in a `useRef\u003cMap\u003cstring, Entry[]\u003e\u003e` scoped to the hook instance\n- Cache is reset when `enabled` flips from `true → false` (popover closed)\n- Debounces fetch by ~100 ms (avoids rapid fetches during fast folder navigation)\n- Calls `POST /api/runners/{runnerId}/files` with `{ path }`\n\n**`packages/ui/src/components/SessionViewer.tsx`** (modified)\n- Add `runnerId?: string` to `SessionViewerProps`\n- Add state: `atMentionOpen`, `atMentionPath` (string, default `\"\"`), `atMentionQuery` (string), `atMentionTriggerOffset` (number — char index of `@` in input)\n- Extend `onChange` handler: detect `@` typed at word boundary → set `atMentionOpen=true`, record trigger offset\n- Extend `onKeyDown` handler: pass `Escape` to close mention popover (takes priority over abort shortcut); `Tab` triggers drill-in on the highlighted folder\n- On `atMentionOpen` close: clear all `atMention*` state\n\n**`packages/ui/src/App.tsx`** (modified, one line)\n- Pass `runnerId={activeSessionInfo?.runnerId ?? undefined}` to `\u003cSessionViewer\u003e` (it is already destructured in `activeSessionInfo`; just add the prop)\n\n### Backend Services\n\nNone required. The existing `POST /api/runners/{id}/files` endpoint accepts `{ path: string }` and returns a directory listing.\n\n### Infrastructure\n\nNo infrastructure changes needed.\n\n## Implementation Strategy\n\n1. Add the `runnerId` prop to `SessionViewer` and pass it from App.tsx — zero risk, purely additive\n2. Build `useAtMentionFiles` hook with fetch + cache logic; unit-testable in isolation\n3. Build `AtMentionPopover` component against the hook; can be developed with mock data\n4. Wire trigger detection into `SessionViewer`'s `onChange`/`onKeyDown`\n5. Implement text insertion/replacement logic and selection callbacks\n6. Polish: dot-file filtering, sort order, mobile tap targets, ARIA attributes\n\n### Testing approach\n\n- Manual smoke test: type `@`, verify popover with CWD listing; navigate into `packages/`, select a file, verify insertion\n- Mobile: test on iOS Safari (popover must not be clipped by keyboard)\n- Keyboard: Arrow keys, Enter, Escape, Tab\n- Edge cases: no runner connected (popover must not trigger), empty directories, deep paths\n\n## Task Breakdown Preview\n\n- [ ] Task 1: Add `runnerId` prop to `SessionViewerProps` and thread from App.tsx\n- [ ] Task 2: Implement `useAtMentionFiles` hook (fetch + cache)\n- [ ] Task 3: Build `AtMentionPopover` component (UI, icons, breadcrumb, sort/filter)\n- [ ] Task 4: Add `@` trigger detection and state management in `SessionViewer`\n- [ ] Task 5: Implement file selection, text insertion, and keyboard handling (Escape, Tab drill-in)\n- [ ] Task 6: Integration, polish, and accessibility (dot-file filtering, mobile, ARIA)\n\n## Dependencies\n\n- **`/api/runners/{id}/files` API** — already exists, no changes required\n- **shadcn `Command` component** — already used by slash-command popover, reuse as-is\n- **`FileExplorer` file/folder icons** — reuse `FileIcon`/`FolderIcon` from existing `FileExplorer.tsx`\n- **`SessionViewer` slash-command state pattern** — architectural reference for `atMentionOpen` state shape\n\n## Success Criteria (Technical)\n\n- Popover appears within 300ms of typing `@` when runner is connected\n- File listing from `useAtMentionFiles` appears within 500ms (runner responding normally)\n- Selecting a file inserts `@relative/path/to/file.tsx ` with cursor positioned after it\n- Pressing Escape closes the popover without modifying the input (other than leaving `@`)\n- No `@` popover fires when no runner is connected (`runnerId` is undefined)\n- TypeScript compiles cleanly (`bun run typecheck` passes)\n- No regressions to slash-command popover behaviour\n\n## Estimated Effort\n\n- **Overall**: 2–3 focused engineering sessions (~1–2 days)\n- **Critical path**: `useAtMentionFiles` → `AtMentionPopover` → `SessionViewer` integration\n- **Highest risk**: Cursor position tracking across textarea edits (browser inconsistencies); mitigate with `selectionStart`/`selectionEnd` after programmatic value set\n\n## Stats\n\nTotal tasks: 6\nParallel tasks: 3 (can be worked on simultaneously)\nSequential tasks: 3 (have dependencies)\nEstimated total effort: ~13.5 hours\n","status":"open","priority":1,"issue_type":"epic","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:56:55Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T17:56:55Z","labels":["epic","epic:at-file-mentions","feature"]}
{"id":"PizzaPi-rc3.1","title":"Add runnerId prop to SessionViewer and thread from App.tsx","description":"\n# Task: Add runnerId prop to SessionViewer and thread from App.tsx\n\n## Description\n\nAdd a `runnerId?: string` prop to `SessionViewerProps` so that `SessionViewer` can call the runner files API. Thread the value from `App.tsx` where `activeSessionInfo.runnerId` is already available.\n\n## Acceptance Criteria\n\n- [ ] `runnerId?: string` is added to `SessionViewerProps` in `SessionViewer.tsx`\n- [ ] `App.tsx` passes `runnerId={activeSessionInfo?.runnerId ?? undefined}` to `\u003cSessionViewer\u003e`\n- [ ] `bun run typecheck` passes with no new errors\n- [ ] No regressions to existing `SessionViewer` behaviour (slash commands, abort shortcut, etc.)\n\n## Technical Details\n\n- File: `packages/ui/src/components/SessionViewer.tsx` — add `runnerId?: string` to the props interface\n- File: `packages/ui/src/App.tsx` — add the `runnerId` prop to the `\u003cSessionViewer\u003e` JSX call\n- `activeSessionInfo` is already destructured in `App.tsx`; `runnerId` is already present on the session info object (it is passed to `\u003cFileExplorer\u003e` elsewhere)\n- The prop does not need to be used by any existing logic yet — it's purely additive and creates the hook for Tasks 4 \u0026 5\n\n## Dependencies\n\n- [ ] None — this is the foundation task\n\n## Effort Estimate\n\n- Size: XS\n- Hours: 0.5\n- Parallel: true\n\n## Definition of Done\n\n- [ ] Code implemented\n- [ ] TypeScript compiles cleanly\n- [ ] Visually verified no UI regression (dev build)\n- [ ] Code reviewed\n","status":"closed","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:57:05Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T18:33:40Z","closed_at":"2026-02-24T18:33:40Z","labels":["epic:at-file-mentions","task"],"dependencies":[{"issue_id":"PizzaPi-rc3.1","depends_on_id":"PizzaPi-rc3","type":"parent-child","created_at":"2026-02-24T12:57:05Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-rc3.2","title":"Implement useAtMentionFiles hook (fetch + cache)","description":"\n# Task: Implement useAtMentionFiles hook (fetch + cache)\n\n## Description\n\nCreate the `useAtMentionFiles` custom React hook that fetches directory listings from `/api/runners/{runnerId}/files` with per-session path-keyed caching and ~100 ms debounce. This hook is the data layer for `AtMentionPopover`.\n\n## Acceptance Criteria\n\n- [ ] Hook created at `packages/ui/src/hooks/useAtMentionFiles.ts`\n- [ ] Signature: `useAtMentionFiles(runnerId: string | undefined, path: string, enabled: boolean): { entries: Entry[], loading: boolean, error: string | null }`\n- [ ] Uses `useRef\u003cMap\u003cstring, Entry[]\u003e\u003e` for path-keyed cache scoped to the hook instance\n- [ ] Cache is reset (Map cleared) when `enabled` flips `true → false`\n- [ ] Fetches are debounced by ~100 ms to avoid rapid requests during folder navigation\n- [ ] Calls `POST /api/runners/{runnerId}/files` with `{ path }` body\n- [ ] Returns `loading: true` while fetch in-flight, `error` on failure\n- [ ] When `runnerId` is `undefined` or `enabled` is `false`, returns empty entries immediately without fetching\n- [ ] `bun run typecheck` passes\n\n## Technical Details\n\n- Location: `packages/ui/src/hooks/useAtMentionFiles.ts`\n- The existing `POST /api/runners/{id}/files` endpoint accepts `{ path: string }` and returns `{ entries: Array\u003c{ name: string, type: 'file' | 'directory' }\u003e }` (verify exact shape from `packages/server/`)\n- Use `useEffect` + `useRef` for debounce timer rather than a library dependency\n- The `Entry` type can be exported from this file or from a shared types location\n- Cache key: the `path` string (absolute or relative — match whatever the API uses)\n\n## Dependencies\n\n- [ ] Verify response shape from `POST /api/runners/{id}/files` in server code before finalising `Entry` type\n\n## Effort Estimate\n\n- Size: S\n- Hours: 2\n- Parallel: true\n\n## Definition of Done\n\n- [ ] Hook implemented with fetch, cache, and debounce\n- [ ] TypeScript compiles cleanly\n- [ ] Manually tested by calling the hook in a test harness or via Task 3\n- [ ] Code reviewed\n","status":"closed","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:57:06Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T18:33:41Z","closed_at":"2026-02-24T18:33:41Z","labels":["epic:at-file-mentions","task"],"dependencies":[{"issue_id":"PizzaPi-rc3.2","depends_on_id":"PizzaPi-rc3","type":"parent-child","created_at":"2026-02-24T12:57:05Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-rc3.3","title":"Build AtMentionPopover component (UI, icons, breadcrumb, sort/filter)","description":"\n# Task: Build AtMentionPopover component (UI, icons, breadcrumb, sort/filter)\n\n## Description\n\nCreate the `AtMentionPopover` React component that renders the file/folder picker popover. It reuses the shadcn `Command`/`CommandList` pattern from the existing slash-command popover, with breadcrumb navigation, sort/filter rules, and loading/empty states.\n\n## Acceptance Criteria\n\n- [ ] Component created at `packages/ui/src/components/AtMentionPopover.tsx`\n- [ ] Props: `open: boolean`, `runnerId: string | undefined`, `path: string`, `query: string`, `onSelectFile(relativePath: string): void`, `onDrillInto(path: string): void`, `onClose(): void`\n- [ ] Uses `useAtMentionFiles` hook internally for data\n- [ ] Shows breadcrumb header with current path; includes \"← Back\" action when path is not root\n- [ ] Reuses `FileIcon` and `FolderIcon` from `FileExplorer.tsx`\n- [ ] Sort order: directories first (alphabetical), then files (alphabetical)\n- [ ] Filters out dot-files and dot-folders (`name.startsWith('.')`)\n- [ ] Filters entries by `query` (case-insensitive substring match on `name`)\n- [ ] Renders loading state while `useAtMentionFiles` is fetching\n- [ ] Renders empty state when no matching entries\n- [ ] Clicking a file calls `onSelectFile(relativePath)` where `relativePath` is relative to the runner CWD\n- [ ] Clicking a folder calls `onDrillInto(newPath)`\n- [ ] `bun run typecheck` passes\n\n## Technical Details\n\n- Follow the exact same `Command` + `CommandList` + `CommandItem` structure used by the slash-command popover in `SessionViewer.tsx` — study it first\n- The popover must be positioned near the textarea cursor; use a simple absolute/fixed positioning strategy anchored to the textarea bottom-left for MVP (no fancy virtual cursor coordinates)\n- `FileIcon` and `FolderIcon` are defined in `packages/ui/src/components/FileExplorer.tsx` — import them directly or extract to a shared icons file if they are not already exported\n- Relative path computation: when the API returns paths relative to CWD, they can be used as-is; if absolute, strip the runner CWD prefix\n\n## Dependencies\n\n- [ ] Task 002 (useAtMentionFiles hook) — can develop against mock data if 002 is not done\n\n## Effort Estimate\n\n- Size: M\n- Hours: 4\n- Parallel: true\n\n## Definition of Done\n\n- [ ] Component implemented with all acceptance criteria met\n- [ ] Tested manually with real runner connection\n- [ ] Dot-file filtering and sort order verified visually\n- [ ] TypeScript compiles cleanly\n- [ ] Code reviewed\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:57:06Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T17:57:06Z","labels":["epic:at-file-mentions","task"],"dependencies":[{"issue_id":"PizzaPi-rc3.3","depends_on_id":"PizzaPi-rc3","type":"parent-child","created_at":"2026-02-24T12:57:06Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-rc3.3","depends_on_id":"PizzaPi-rc3.2","type":"blocks","created_at":"2026-02-24T12:57:39Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-rc3.4","title":"Add @ trigger detection and atMention state management in SessionViewer","description":"\n# Task: Add @ trigger detection and atMention state management in SessionViewer\n\n## Description\n\nExtend `SessionViewer`'s `onChange` and `onKeyDown` handlers to detect when the user types `@` at a word boundary, open the `AtMentionPopover`, and manage the associated state (`atMentionOpen`, `atMentionPath`, `atMentionQuery`, `atMentionTriggerOffset`).\n\n## Acceptance Criteria\n\n- [ ] Four new state variables added to `SessionViewer`: `atMentionOpen` (boolean), `atMentionPath` (string, default `\"\"`), `atMentionQuery` (string), `atMentionTriggerOffset` (number)\n- [ ] `onChange` handler detects `@` typed at a word boundary (character before `@` is space, newline, or start-of-string) and sets `atMentionOpen = true`, records `atMentionTriggerOffset` (index of `@` in input value)\n- [ ] `atMentionQuery` is kept in sync: it is the substring from `atMentionTriggerOffset + 1` to current cursor position (i.e., what the user has typed after `@`)\n- [ ] `onKeyDown` handler: `Escape` when `atMentionOpen` is true closes the popover (prevents event from propagating to abort shortcut)\n- [ ] When `atMentionOpen` closes for any reason, all `atMention*` state is reset to defaults\n- [ ] No `@` popover fires when `runnerId` is `undefined`\n- [ ] Existing slash-command popover behaviour is unaffected (mutually exclusive via `commandOpen` vs `atMentionOpen`)\n- [ ] `AtMentionPopover` is rendered in the JSX (even if wired incompletely — file selection handled in Task 005)\n- [ ] `bun run typecheck` passes\n\n## Technical Details\n\n- Study the existing `commandOpen` / `setCommandOpen` pattern and mirror it for `atMentionOpen`\n- Word boundary check: `inputValue[triggerIndex - 1]` is `undefined` (start) or matches `/[\\s]/`\n- `atMentionTriggerOffset` should be the cursor position at the moment `@` was typed (`event.target.selectionStart - 1` after the onChange event fires — note: onChange fires after the character is inserted)\n- When `atMentionOpen` is already true and the user keeps typing, update `atMentionQuery` on every `onChange`; if backspace deletes past the `@` trigger character, close the popover\n- `atMentionPath` controls which directory the `AtMentionPopover` is browsing; drilling into a folder calls `setAtMentionPath(newPath)`\n\n## Dependencies\n\n- [ ] Task 001 (runnerId prop) — required so SessionViewer receives runnerId\n- [ ] Task 003 (AtMentionPopover) — needed to render the popover in JSX (can stub with placeholder if 003 not complete)\n\n## Effort Estimate\n\n- Size: S\n- Hours: 2\n- Parallel: false\n\n## Definition of Done\n\n- [ ] Trigger detection works: typing `@` opens popover, typing after `@` updates query, backspacing past `@` closes popover\n- [ ] Escape closes popover without side effects\n- [ ] No regressions to slash-command popover\n- [ ] TypeScript compiles cleanly\n- [ ] Code reviewed\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:57:07Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T17:57:07Z","labels":["epic:at-file-mentions","task"],"dependencies":[{"issue_id":"PizzaPi-rc3.4","depends_on_id":"PizzaPi-rc3","type":"parent-child","created_at":"2026-02-24T12:57:06Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-rc3.4","depends_on_id":"PizzaPi-rc3.1","type":"blocks","created_at":"2026-02-24T12:57:40Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-rc3.5","title":"Implement file selection, text insertion, and keyboard handling (Tab drill-in)","description":"\n# Task: Implement file selection, text insertion, and keyboard handling (Tab drill-in)\n\n## Description\n\nImplement the `onSelectFile` and `onDrillInto` callbacks passed to `AtMentionPopover`. On file selection, replace the `@…query` substring in the textarea with `@relative/path/to/file ` and reposition the cursor. Also handle `Tab` key to drill into the highlighted folder.\n\n## Acceptance Criteria\n\n- [ ] `onSelectFile(relativePath)` callback: replaces the substring from `atMentionTriggerOffset` to current cursor with `@{relativePath} ` (note trailing space), sets the cursor position immediately after the inserted text using `textarea.setSelectionRange`\n- [ ] After file insertion, all `atMention*` state is reset (popover closes)\n- [ ] `onDrillInto(path)` callback: sets `atMentionPath = path` and clears `atMentionQuery` (stays open)\n- [ ] `Tab` key when `atMentionOpen` is true and highlighted item is a folder: calls `onDrillInto` for that folder (prevents default tab focus change)\n- [ ] \"← Back\" action in `AtMentionPopover` triggers a parent-controlled `onBack()` that pops the last path segment from `atMentionPath`\n- [ ] Pressing Escape correctly resets state (covered by Task 004 but should be integration-verified here)\n- [ ] Text insertion is correct when `@` is mid-sentence (not just at end of input)\n- [ ] `bun run typecheck` passes\n\n## Technical Details\n\n- `textarea` ref: `SessionViewer` likely already uses a ref for the textarea element (e.g., for focus management on slash-command selection); reuse or add a `textareaRef`\n- Text replacement: `value.slice(0, atMentionTriggerOffset) + '@' + relativePath + ' ' + value.slice(cursorPosition)`\n- `cursorPosition` at the moment of selection is `textarea.selectionStart` (captured synchronously in the callback)\n- `setSelectionRange`: call after state update; use `useEffect` or `requestAnimationFrame` to ensure the DOM reflects the new value before calling\n- The `onBack()` prop on `AtMentionPopover`: compute parent path with `path.split('/').slice(0, -1).join('/')` (empty string → root)\n- `Tab` key: listen in `onKeyDown`; query the `Command` component for the highlighted item (shadcn `Command` may expose an `aria-selected` item); alternative: maintain `highlightedItem` in state synced with arrow-key navigation\n\n## Dependencies\n\n- [ ] Task 003 (AtMentionPopover) — onSelectFile/onDrillInto callbacks wired via props\n- [ ] Task 004 (atMention state) — provides atMentionTriggerOffset, atMentionPath, textareaRef\n\n## Effort Estimate\n\n- Size: M\n- Hours: 3\n- Parallel: false\n\n## Definition of Done\n\n- [ ] File selection inserts correct text with trailing space and cursor positioned after it\n- [ ] Mid-sentence `@` insertion works correctly\n- [ ] Tab key drills into folders without triggering focus change\n- [ ] Back navigation pops path segments correctly\n- [ ] TypeScript compiles cleanly\n- [ ] Code reviewed\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:57:07Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T17:57:07Z","labels":["epic:at-file-mentions","task"],"dependencies":[{"issue_id":"PizzaPi-rc3.5","depends_on_id":"PizzaPi-rc3","type":"parent-child","created_at":"2026-02-24T12:57:07Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-rc3.5","depends_on_id":"PizzaPi-rc3.3","type":"blocks","created_at":"2026-02-24T12:57:41Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-rc3.5","depends_on_id":"PizzaPi-rc3.4","type":"blocks","created_at":"2026-02-24T12:57:42Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-rc3.6","title":"Integration, polish, and accessibility (dot-files, mobile, ARIA)","description":"\n# Task: Integration, polish, and accessibility (dot-files, mobile, ARIA)\n\n## Description\n\nEnd-to-end integration validation, UX polish, and accessibility hardening for the `@` file-mention feature. Covers dot-file filtering, mobile layout (iOS Safari keyboard), ARIA attributes, and verifying all edge cases from the success criteria.\n\n## Acceptance Criteria\n\n- [ ] Popover appears within 300 ms of typing `@` with runner connected (measure visually)\n- [ ] File listing from `useAtMentionFiles` appears within 500 ms (normal runner latency)\n- [ ] Dot-files and dot-folders (`.git`, `.env`, etc.) are filtered from the listing\n- [ ] No `@` popover fires when no runner is connected (`runnerId` is `undefined`)\n- [ ] Selecting a file inserts `@relative/path/to/file.tsx ` with cursor after it\n- [ ] Pressing `Escape` closes the popover without modifying input (other than the `@` remaining)\n- [ ] Slash-command popover behaviour is unaffected — full regression pass\n- [ ] On iOS Safari: popover is not clipped by the virtual keyboard (use `max-height` + `overflow-y: auto` with viewport-aware positioning or `env(keyboard-inset-height)`)\n- [ ] ARIA: popover has `role=\"listbox\"`, items have `role=\"option\"`, `aria-selected` reflects keyboard highlight, popover is `aria-label`-ed appropriately\n- [ ] Empty directory shows a friendly \"No files found\" message\n- [ ] Deep path navigation (5+ levels) works without errors\n- [ ] `bun run typecheck` passes with zero errors\n- [ ] `bun run build` succeeds\n\n## Technical Details\n\n- **Mobile**: test on iOS Safari simulator or real device; the shadcn `Command` popover may need `max-h-[50vh]` and `overflow-y-auto` with bottom-anchoring relative to the textarea\n- **ARIA**: shadcn `Command` provides baseline ARIA; verify that `AtMentionPopover` adds `aria-label=\"File mentions\"` to the wrapping element, and that `CommandItem` elements receive meaningful labels (e.g., `aria-label=\"Select file: index.ts\"`)\n- **Dot-file filtering**: already implemented in Task 003, but validate with real directories that contain dot-entries\n- **Performance**: if listing is slow, confirm the 100 ms debounce in `useAtMentionFiles` prevents excessive requests during rapid folder navigation\n- **Edge cases to test**:\n  - Empty directory (no files, no folders)\n  - `@` typed at position 0 (start of input)\n  - `@` typed mid-word (should NOT trigger — word boundary check)\n  - Switching sessions while popover is open (popover should close / runnerId changes)\n  - Very long file paths (check truncation in popover items)\n\n## Dependencies\n\n- [ ] Task 005 (full feature wired) — must be complete before integration testing\n\n## Effort Estimate\n\n- Size: S\n- Hours: 2\n- Parallel: false\n\n## Definition of Done\n\n- [ ] All acceptance criteria verified manually\n- [ ] Mobile layout tested (iOS Safari)\n- [ ] ARIA attributes present and correct (verified with browser accessibility inspector)\n- [ ] `bun run typecheck` passes\n- [ ] `bun run build` succeeds\n- [ ] Code reviewed\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-24T17:57:08Z","created_by":"Jordan Pizza","updated_at":"2026-02-24T17:57:08Z","labels":["epic:at-file-mentions","task"],"dependencies":[{"issue_id":"PizzaPi-rc3.6","depends_on_id":"PizzaPi-rc3","type":"parent-child","created_at":"2026-02-24T12:57:07Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-rc3.6","depends_on_id":"PizzaPi-rc3.5","type":"blocks","created_at":"2026-02-24T12:57:43Z","created_by":"Jordan Pizza","metadata":"{}"}]}
