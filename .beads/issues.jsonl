{"id":"PizzaPi-b8h","title":"Epic: socketio-migration","description":"\n# Epic: socketio-migration\n\n## Overview\n\nMigrate PizzaPi's custom Bun WebSocket relay to Socket.IO with the Redis adapter, enabling multi-server horizontal scaling. The current architecture stores all session/viewer/runner/terminal state in process-local `Map`/`Set` objects across ~1,500 lines in `registry.ts` and `relay.ts`. Socket.IO replaces hand-rolled room management, reconnection logic, and cross-server fan-out with battle-tested primitives, while a new `packages/protocol/` package provides compile-time type safety for all WebSocket events.\n\n## Architecture Decisions\n\n- **Socket.IO v4.8+ on Bun**: Socket.IO supports Bun via its `node:http` compatibility layer. A spike task verifies this before committing to the migration. CLI/runner clients use `transports: [\"websocket\"]` (skip HTTP polling); browser clients use default transport negotiation.\n- **Namespace-per-concern**: Map the 5 current WS endpoints to Socket.IO namespaces (`/relay`, `/viewer`, `/runner`, `/terminal`, `/hub`). Each namespace has its own typed event maps and auth middleware.\n- **Redis adapter for fan-out**: Use `@socket.io/redis-adapter` on the existing `PIZZAPI_REDIS_URL`. Room broadcasts automatically span servers. Session metadata, runner registry, and terminal registry move to Redis hashes for cross-server visibility.\n- **Shared protocol package**: New `packages/protocol/` exports `ServerToClientEvents`, `ClientToServerEvents`, `InterServerEvents`, and `SocketData` per namespace. All packages depend on it, giving compile-time safety.\n- **Backward compatibility shim**: Keep raw WS `/ws/sessions` endpoint alive for 1–2 releases so older CLI versions still connect. Server detects protocol on connection and routes accordingly.\n- **Connection State Recovery**: Enable Socket.IO v4's built-in recovery (2-min window) to replace the manual `resync` flow for brief disconnects. Longer gaps fall back to Redis event cache replay.\n\n## Technical Approach\n\n### New Package: `packages/protocol/`\n\n- TypeScript interfaces for all event maps, organized by namespace\n- Shared `SocketData` type (replacing `WsData` for Socket.IO metadata)\n- Exported as ESM; added to build order before `server`, `ui`, `cli`\n- ~200 lines total, derived from the existing `{ type: string }` message protocol in `relay.ts`\n\n### Server Changes (`packages/server/`)\n\n- **`src/index.ts`**: Attach `Socket.IO Server` to the Bun HTTP server. Configure Redis adapter, CORS, connection state recovery. Keep existing `fetch` handler for REST routes.\n- **`src/ws/relay.ts` → `src/ws/namespaces/`**: Split the monolithic 710-line relay handler into per-namespace modules (`relay.ts`, `viewer.ts`, `runner.ts`, `terminal.ts`, `hub.ts`). Each module registers event handlers on its namespace.\n- **`src/ws/registry.ts`**: Replace in-memory `Map`/`Set` state with:\n  - Socket.IO rooms for viewer sets, hub clients, terminal viewers (eliminates `Set\u003cServerWebSocket\u003e` tracking)\n  - Redis hashes for session metadata, runner registry, terminal registry (cross-server visibility)\n  - Keep `thinkingStartTimes`/`thinkingDurations` as socket-scoped in-memory state\n- **`src/routes/ws.ts`**: Remove entirely (Socket.IO handles upgrade + auth via namespace middleware)\n- **Auth middleware**: Per-namespace Socket.IO middleware replaces `handleWsUpgrade` auth checks. API key auth for `/relay` and `/runner`; session cookie auth for `/viewer`, `/hub`, `/terminal`.\n- **Push notifications**: Replace `session.viewers.size \u003e 0` with `io.of(\"/viewer\").adapter.sockets(new Set([sessionId]))` for cross-server viewer count.\n\n### UI Changes (`packages/ui/`)\n\n- Replace `new WebSocket(...)` in `App.tsx`, `SessionSidebar.tsx`, `WebTerminal.tsx` with `socket.io-client` namespace connections\n- Remove all manual reconnection/backoff logic (~100+ lines across 3 files)\n- Use Socket.IO's `connect_error`, `reconnect`, `reconnect_attempt` events for connection status UI\n- Import typed event maps from `packages/protocol/`\n\n### CLI Changes (`packages/cli/`)\n\n- **`remote.ts`**: Replace `new WebSocket(...)` with `io(\"/relay\", { auth: { apiKey }, transports: [\"websocket\"] })`. Remove manual reconnection with exponential backoff. Use Socket.IO acks instead of `seq`/`event_ack`.\n- **`daemon.ts`**: Replace `new WebSocket(...)` with `io(\"/runner\", { auth: { apiKey, runnerId, runnerSecret }, transports: [\"websocket\"] })`. Remove manual reconnection logic.\n\n### Infrastructure\n\n- No new infrastructure required — Redis is already in the stack\n- Redis adapter uses separate pub/sub connections with distinct key prefixes (no conflict with event cache)\n- Docker Compose config unchanged (same Redis service)\n\n## Implementation Strategy\n\n1. **Spike first**: Verify Socket.IO + Bun compatibility before any production code changes\n2. **Protocol package**: Build the shared types package (unblocks all other work)\n3. **Server-side migration**: Refactor registry + relay into namespace handlers with Redis-backed state\n4. **Client migration**: Update UI, CLI, and runner clients (can proceed in parallel once server namespaces are up)\n5. **Backward compat**: Add shim for raw WS clients during transition\n6. **Validation**: End-to-end testing of multi-server fan-out, reconnection, and all existing features\n\n## Task Breakdown Preview\n\n- [ ] Task 1: Bun + Socket.IO compatibility spike (verify server + client work under Bun)\n- [ ] Task 2: Create `packages/protocol/` with typed event interfaces for all 5 namespaces\n- [ ] Task 3: Server — integrate Socket.IO server with Bun.serve, Redis adapter, and connection state recovery\n- [ ] Task 4: Server — migrate registry.ts to Redis-backed state + Socket.IO rooms\n- [ ] Task 5: Server — implement namespace handlers (relay, viewer, runner, terminal, hub) with auth middleware\n- [ ] Task 6: Client — migrate UI WebSocket connections to socket.io-client\n- [ ] Task 7: Client — migrate CLI remote.ts to socket.io-client\n- [ ] Task 8: Client — migrate runner daemon.ts to socket.io-client\n- [ ] Task 9: Backward compatibility shim for raw WS CLI clients\n- [ ] Task 10: End-to-end validation and multi-server fan-out testing\n\n## Dependencies\n\n### External\n- `socket.io` v4.8+ (server)\n- `socket.io-client` (UI, CLI, runner)\n- `@socket.io/redis-adapter` (server)\n- Redis 6+ (already in stack)\n\n### Internal\n- `packages/protocol/` must be built before `server`, `ui`, `cli`\n- Build order becomes: `protocol` → `tools` → `server` → `ui` → `cli`\n- Vite proxy config may need adjustment for Socket.IO transport negotiation\n\n### Task Dependencies\n- Task 1 (spike) gates all other tasks\n- Task 2 (protocol) gates Tasks 3–8\n- Tasks 3–5 (server) gate Tasks 6–8 (clients)\n- Tasks 6, 7, 8 can proceed in parallel\n- Task 9 can proceed after Task 5\n- Task 10 requires all other tasks complete\n\n## Success Criteria (Technical)\n\n- **Multi-server fan-out**: Viewer on server B receives events from TUI on server A within 100ms\n- **Zero-downtime restart**: Viewers reconnect to surviving instance within 1s\n- **Code reduction**: Net ≥ 300 lines removed from WebSocket-related code\n- **Type safety**: 100% of WS events typed; zero `as any` casts in event handlers\n- **Bundle size**: UI bundle grows by \u003c 50KB gzipped\n- **Feature parity**: Session viewing, collab mode, runner management, terminals, hub, push notifications all work identically\n- **Bun compatibility**: All tests pass under Bun runtime\n\n## Stats\n\nTotal tasks: 10\nParallel tasks: 4 (can be worked on simultaneously)\nSequential tasks: 6 (have dependencies)\nEstimated total effort: 69 hours hours\n\n## Estimated Effort\n\n- **Overall timeline**: 2–3 weeks (assuming spike passes in first 1–2 days)\n- **Critical path**: Spike → Protocol → Server migration → Client migration → Validation\n- **Parallelism**: After server namespaces are live, UI/CLI/runner client migrations can proceed concurrently (3 parallel streams)\n- **Risk buffer**: 2–3 days for Bun compatibility issues or unexpected Socket.IO edge cases\n- **Breakdown by task**:\n  - Spike: 0.5 day\n  - Protocol package: 0.5 day\n  - Server migration (Tasks 3–5): 4–5 days\n  - Client migrations (Tasks 6–8): 3–4 days (parallel)\n  - Backward compat shim: 1 day\n  - E2E validation: 1–2 days\n","status":"open","priority":1,"issue_type":"epic","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:44:57Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:44:57Z","labels":["epic","epic:socketio-migration","feature"]}
{"id":"PizzaPi-b8h.1","title":"Bun + Socket.IO Compatibility Spike","description":"\n# Task: Bun + Socket.IO Compatibility Spike\n\n## Description\n\nVerify that Socket.IO v4.8+ works reliably with Bun.serve on both server and client sides before committing to the migration. This is a go/no-go gate for the entire epic.\n\n## Acceptance Criteria\n\n- [ ] Socket.IO Server attaches to Bun.serve and accepts WebSocket connections\n- [ ] `socket.io-client` connects from a Bun process (simulating CLI/runner)\n- [ ] `socket.io-client` connects from a browser (Vite dev server)\n- [ ] `@socket.io/redis-adapter` initializes and broadcasts across two local server instances\n- [ ] Connection State Recovery works (disconnect + reconnect within 2 min resumes events)\n- [ ] Namespace-based connections work (`io.of(\"/relay\")`, etc.)\n- [ ] Documented any workarounds needed (e.g., `node:http` compat layer)\n\n## Technical Details\n\n- Create a minimal `spike/` directory with a test server and test clients\n- Server: Bun.serve + Socket.IO with Redis adapter, 2-3 namespaces\n- Client 1: Bun script using `socket.io-client` (WS-only transport)\n- Client 2: Simple HTML page using `socket.io-client` (default transport)\n- Test cross-server fan-out by running two server instances on different ports\n- Measure round-trip latency for event relay\n\n### Key Risk Areas\n- Bun's `node:http` compatibility layer may have gaps\n- `socket.io-client` engine.io transport may behave differently in Bun vs Node\n- Redis adapter pub/sub may need Bun-specific connection handling\n\n## Dependencies\n\n- [ ] None — this is the first task\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: false (gates all other work)\n\n## Definition of Done\n\n- [ ] Spike code demonstrates all acceptance criteria\n- [ ] Written summary of findings (works / doesn't work / workarounds needed)\n- [ ] Go/no-go decision documented\n- [ ] Spike code can be deleted (not production code)\n","status":"in_progress","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:08Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:55:35Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.1","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:08Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.10","title":"End-to-End Validation and Multi-Server Fan-Out Testing","description":"\n# Task: End-to-End Validation and Multi-Server Fan-Out Testing\n\n## Description\n\nComprehensive testing of the complete Socket.IO migration: all features work end-to-end, multi-server fan-out works via Redis adapter, reconnection is seamless, backward compatibility holds, and performance meets targets.\n\n## Acceptance Criteria\n\n- [ ] **Session viewing**: Browser viewer sees all TUI events in real-time\n- [ ] **Collab mode**: Viewer can send messages that reach the TUI agent\n- [ ] **Runner management**: Runner daemon registers, receives new_session, spawns workers correctly\n- [ ] **Terminal streaming**: Web terminal PTY works (input + output)\n- [ ] **Hub session list**: SessionSidebar shows live session list updates\n- [ ] **Push notifications**: Sent when no viewers connected (cross-server check)\n- [ ] **Multi-server fan-out**: TUI on server A → viewer on server B receives events \u003c 100ms\n- [ ] **Reconnection**: Brief disconnect (\u003c 2 min) resumes without manual resync\n- [ ] **Backward compat**: Old CLI version connects via raw WS alongside new Socket.IO clients\n- [ ] **Code metrics**: Net ≥ 300 lines removed from WS-related code\n- [ ] **Type safety**: Zero `as any` casts in event handlers (verified by grep)\n- [ ] **Bundle size**: UI bundle increase \u003c 50KB gzipped\n\n## Technical Details\n\n### Test Scenarios\n\n#### Single-Server Tests\n1. Start server + connect TUI via CLI → verify session appears in hub\n2. Open browser viewer → verify events stream in real-time\n3. Send viewer message in collab mode → verify TUI receives it\n4. Spawn terminal via runner → verify PTY works in browser\n5. Disconnect viewer network → reconnect within 2 min → verify no event gap\n6. Disconnect viewer \u003e 2 min → reconnect → verify Redis replay works\n\n#### Multi-Server Tests\n7. Start 2 server instances (different ports, same Redis)\n8. Connect TUI to server A, viewer to server B → verify events flow\n9. Connect runner to server A, send new_session from server B → verify runner receives it\n10. Check hub on server B shows sessions from server A\n11. Kill server A → verify viewer reconnects to server B\n\n#### Backward Compatibility Tests\n12. Connect old CLI (raw WS) to server → verify session works\n13. Connect new CLI (Socket.IO) alongside old CLI → verify both work\n14. Verify deprecation warning logged for old CLI\n\n#### Performance Tests\n15. Measure event relay latency (TUI → viewer) — target \u003c 50ms single-server, \u003c 100ms cross-server\n16. Verify no memory leaks after 1000+ events\n\n### Metrics Collection\n```bash\n# Count removed lines\ngit diff --stat main -- packages/server/src/ws/ packages/ui/src/ packages/cli/src/extensions/remote.ts packages/cli/src/runner/daemon.ts\n\n# Check for any casts\ngrep -r \"as any\" packages/server/src/ws/ packages/ui/src/ packages/cli/src/extensions/remote.ts packages/cli/src/runner/daemon.ts\n\n# UI bundle size\nbun run build:ui \u0026\u0026 ls -la packages/ui/dist/assets/*.js\n```\n\n## Dependencies\n\n- [ ] All tasks 001-009 must be complete\n\n## Effort Estimate\n\n- Size: M\n- Hours: 8\n- Parallel: false (requires all other work complete)\n\n## Definition of Done\n\n- [ ] All test scenarios pass\n- [ ] Performance targets met\n- [ ] Code metrics verified (line reduction, type safety, bundle size)\n- [ ] No regressions in any existing feature\n- [ ] `bun run build` succeeds (full build)\n- [ ] `bun run typecheck` passes\n- [ ] Documentation updated (README, AGENTS.md env vars if changed)\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:14Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:14Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.10","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:13Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.10","depends_on_id":"PizzaPi-b8h.6","type":"blocks","created_at":"2026-02-22T17:45:37Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.10","depends_on_id":"PizzaPi-b8h.7","type":"blocks","created_at":"2026-02-22T17:45:37Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.10","depends_on_id":"PizzaPi-b8h.8","type":"blocks","created_at":"2026-02-22T17:45:38Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.10","depends_on_id":"PizzaPi-b8h.9","type":"blocks","created_at":"2026-02-22T17:45:39Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.2","title":"Create packages/protocol with Typed Event Interfaces","description":"\n# Task: Create packages/protocol with Typed Event Interfaces\n\n## Description\n\nCreate a new `packages/protocol/` package that defines TypeScript interfaces for all Socket.IO events across all 5 namespaces. This package becomes a shared dependency for server, UI, and CLI packages, providing compile-time type safety for all WebSocket communication.\n\n## Acceptance Criteria\n\n- [ ] `packages/protocol/` exists with `package.json`, `tsconfig.json`, ESM output\n- [ ] Exports typed event maps per namespace: `/relay`, `/viewer`, `/runner`, `/terminal`, `/hub`\n- [ ] Each namespace defines `ServerToClientEvents`, `ClientToServerEvents`, `InterServerEvents`, `SocketData`\n- [ ] All existing message types from `relay.ts` are covered (no missing events)\n- [ ] `packages/server`, `packages/ui`, and `packages/cli` can import from `@pizzapi/protocol`\n- [ ] `bun run typecheck` passes with the new package in the build graph\n- [ ] Build order updated in root `package.json`: `protocol` → `tools` → `server` → `ui` → `cli`\n\n## Technical Details\n\n- Audit current message protocol by scanning `relay.ts` for all `type:` string literals and their payloads\n- Audit `registry.ts` for `WsData`, `SharedSession`, `RunnerEntry`, and related types\n- Map current `{ type: string, ...payload }` messages to Socket.IO event signatures\n- Organize by namespace:\n  - `/relay` — TUI session events (register, session_event, heartbeat, state, exec commands)\n  - `/viewer` — Browser viewer events (session_event, state, viewer_message, exec commands)\n  - `/runner` — Runner events (register, new_session, kill_session, skills, usage)\n  - `/terminal` — Terminal PTY events (data, resize, spawn, kill)\n  - `/hub` — Session list events (session_started, session_ended, session_updated, full list)\n\n### Files to Create\n- `packages/protocol/package.json`\n- `packages/protocol/tsconfig.json`\n- `packages/protocol/src/index.ts` (re-exports)\n- `packages/protocol/src/relay.ts`\n- `packages/protocol/src/viewer.ts`\n- `packages/protocol/src/runner.ts`\n- `packages/protocol/src/terminal.ts`\n- `packages/protocol/src/hub.ts`\n- `packages/protocol/src/shared.ts` (common types like SessionInfo, RunnerInfo)\n\n### Files to Modify\n- `package.json` (root) — add `build:protocol` script, update build order\n- `tsconfig.base.json` — add protocol to project references if needed\n\n## Dependencies\n\n- [ ] Task 001 (spike must confirm Socket.IO works on Bun)\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: false (unblocks all subsequent tasks)\n\n## Definition of Done\n\n- [ ] Package builds cleanly with `bun run build:protocol`\n- [ ] All 5 namespace event maps fully typed\n- [ ] Shared types cover session metadata, runner info, terminal info\n- [ ] Integration test: import types in server/ui/cli and `tsc` passes\n- [ ] No `any` types in event definitions\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:09Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:09Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.2","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:09Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.2","depends_on_id":"PizzaPi-b8h.1","type":"blocks","created_at":"2026-02-22T17:45:39Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.3","title":"Integrate Socket.IO Server with Bun.serve and Redis Adapter","description":"\n# Task: Integrate Socket.IO Server with Bun.serve and Redis Adapter\n\n## Description\n\nSet up the Socket.IO server instance attached to PizzaPi's existing Bun.serve HTTP server. Configure the Redis adapter for cross-server pub/sub, enable Connection State Recovery, and define the 5 namespaces with placeholder handlers. This establishes the server-side foundation for the migration.\n\n## Acceptance Criteria\n\n- [ ] Socket.IO Server created and attached to Bun.serve in `src/index.ts`\n- [ ] Redis adapter configured using existing `PIZZAPI_REDIS_URL` with distinct key prefix\n- [ ] Connection State Recovery enabled (2-minute window)\n- [ ] 5 namespaces registered: `/relay`, `/viewer`, `/runner`, `/terminal`, `/hub`\n- [ ] CORS configured via Socket.IO options (replacing manual headers)\n- [ ] Existing REST API routes (`/api/*`) continue working alongside Socket.IO\n- [ ] Server starts without errors and accepts Socket.IO connections\n- [ ] `socket.io`, `@socket.io/redis-adapter` added to server dependencies\n\n## Technical Details\n\n### Files to Modify\n- `packages/server/package.json` — add `socket.io`, `@socket.io/redis-adapter` dependencies\n- `packages/server/src/index.ts` — attach Socket.IO to Bun.serve, configure adapter + CORS + CSR\n\n### Files to Create\n- `packages/server/src/ws/namespaces/index.ts` — namespace registration entry point\n- `packages/server/src/ws/namespaces/relay.ts` — placeholder `/relay` namespace\n- `packages/server/src/ws/namespaces/viewer.ts` — placeholder `/viewer` namespace\n- `packages/server/src/ws/namespaces/runner.ts` — placeholder `/runner` namespace\n- `packages/server/src/ws/namespaces/terminal.ts` — placeholder `/terminal` namespace\n- `packages/server/src/ws/namespaces/hub.ts` — placeholder `/hub` namespace\n\n### Integration Pattern\n```typescript\nimport { Server } from \"socket.io\";\nimport { createAdapter } from \"@socket.io/redis-adapter\";\n\n// Attach to existing Bun.serve\nconst io = new Server(server, {\n  cors: { origin: ALLOWED_ORIGINS, credentials: true },\n  connectionStateRecovery: { maxDisconnectionDuration: 2 * 60 * 1000 },\n  transports: [\"websocket\", \"polling\"],\n});\n\n// Redis adapter (reuse existing Redis URL, separate prefix)\nio.adapter(createAdapter(pubClient, subClient, { key: \"pizzapi-sio\" }));\n```\n\n### Key Consideration\n- The existing `websocket: { open, message, close }` handler on Bun.serve must coexist with Socket.IO during the transition period (Task 009 handles backward compat)\n\n## Dependencies\n\n- [ ] Task 001 (spike confirms Bun compatibility)\n- [ ] Task 002 (protocol types for namespace typing)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 6\n- Parallel: false (foundation for tasks 004-005)\n\n## Definition of Done\n\n- [ ] Server starts with Socket.IO attached\n- [ ] Redis adapter connects and logs successful initialization\n- [ ] All 5 namespaces accept connections (verified with socket.io-client)\n- [ ] REST API routes unaffected\n- [ ] `bun run build:server` succeeds\n- [ ] `bun run typecheck` passes\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:10Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:10Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.3","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:09Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.3","depends_on_id":"PizzaPi-b8h.1","type":"blocks","created_at":"2026-02-22T17:45:40Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.3","depends_on_id":"PizzaPi-b8h.2","type":"blocks","created_at":"2026-02-22T17:45:40Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.4","title":"Migrate Registry to Redis-Backed State and Socket.IO Rooms","description":"\n# Task: Migrate Registry to Redis-Backed State and Socket.IO Rooms\n\n## Description\n\nRewrite `packages/server/src/ws/registry.ts` (~796 lines) to replace in-memory `Map`/`Set` state with Redis hashes for cross-server visibility and Socket.IO rooms for viewer/hub tracking. This is the core data layer change enabling horizontal scaling.\n\n## Acceptance Criteria\n\n- [ ] Session metadata stored in Redis hashes (`pizzapi:sessions:{id}`) instead of in-memory `Map`\n- [ ] Runner registry stored in Redis hashes (`pizzapi:runners:{id}`) instead of in-memory `Map`\n- [ ] Terminal registry stored in Redis hashes (`pizzapi:terminals:{id}`) instead of in-memory `Map`\n- [ ] Viewer tracking uses Socket.IO rooms (`session:{id}`) instead of `Set\u003cServerWebSocket\u003e`\n- [ ] Hub client tracking uses Socket.IO rooms (`hub`) instead of `Set\u003cServerWebSocket\u003e`\n- [ ] `thinkingStartTimes`/`thinkingDurations` remain in-memory (socket-scoped)\n- [ ] All registry functions updated with async signatures where Redis calls are needed\n- [ ] `broadcastToViewers()` replaced by `io.to(sessionId).emit()`\n- [ ] `broadcastToHub()` replaced by `io.to(\"hub\").emit()`\n- [ ] Cross-server viewer count available via `io.of(\"/viewer\").adapter.sockets()`\n- [ ] Push notification logic uses cross-server viewer count\n\n## Technical Details\n\n### State Migration Map\n| Current | Target | Mechanism |\n|---------|--------|-----------|\n| `sharedSessions` Map | Redis hash per session | `HSET/HGET/HDEL` |\n| `session.viewers` Set | Socket.IO room | `socket.join(\"session:{id}\")` |\n| `session.tuiWs` | Socket reference on `/relay` namespace | Socket instance |\n| `hubClients` Set | Socket.IO room \"hub\" | `socket.join(\"hub\")` |\n| `runners` Map | Redis hash per runner | `HSET/HGET/HDEL` |\n| `terminals` Map | Redis hash per terminal | `HSET/HGET/HDEL` |\n| `seq` counter | Redis INCR or Socket.IO acks | `INCR pizzapi:seq:{id}` |\n\n### Files to Modify\n- `packages/server/src/ws/registry.ts` — major rewrite (all functions)\n\n### Files to Create\n- `packages/server/src/ws/redis-state.ts` — Redis hash helpers for session/runner/terminal CRUD\n\n### Key Considerations\n- Registry functions become async (callers in relay.ts / namespace handlers must await)\n- Redis serialization: store JSON in hash fields, parse on read\n- Session `tuiWs` socket reference stays local (it's the connection to this specific server)\n- TTL on Redis keys for auto-cleanup of stale sessions\n- Sweep logic (`sweepExpiredSharedSessions`) adapts to check Redis instead of local Map\n\n## Dependencies\n\n- [ ] Task 003 (Socket.IO server + Redis adapter must be in place)\n\n## Effort Estimate\n\n- Size: L\n- Hours: 10\n- Parallel: false (modifies the core data layer)\n\n## Definition of Done\n\n- [ ] All registry functions work with Redis + rooms\n- [ ] Cross-server fan-out verified (viewer on server B sees events from TUI on server A)\n- [ ] No remaining in-memory `Map`/`Set` for shared state (except thinking tracking)\n- [ ] Existing sweep/cleanup logic works with Redis state\n- [ ] `bun run typecheck` passes\n- [ ] `bun run build:server` succeeds\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:11Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:11Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.4","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:10Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.4","depends_on_id":"PizzaPi-b8h.3","type":"blocks","created_at":"2026-02-22T17:45:41Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.5","title":"Implement Namespace Handlers with Auth Middleware","description":"\n# Task: Implement Namespace Handlers with Auth Middleware\n\n## Description\n\nReplace the monolithic `relay.ts` (710 lines) with per-namespace Socket.IO event handlers. Each namespace gets its own auth middleware and typed event handlers using the protocol package. Remove `routes/ws.ts` (96 lines) as Socket.IO handles upgrade + auth natively.\n\n## Acceptance Criteria\n\n- [ ] `/relay` namespace: TUI registration, session events, heartbeat, state, exec commands — with API key auth\n- [ ] `/viewer` namespace: session event streaming, viewer messages, exec commands — with session cookie auth\n- [ ] `/runner` namespace: runner registration, new_session, kill_session, skills, usage — with API key auth\n- [ ] `/terminal` namespace: PTY data, resize, spawn, kill — with session cookie auth\n- [ ] `/hub` namespace: session list feed (started/ended/updated) — with session cookie auth\n- [ ] Auth middleware per namespace validates credentials before connection\n- [ ] `thinking_start`/`thinking_end`/`augmentMessageThinkingDurations` logic ported to `/relay` handler\n- [ ] `routes/ws.ts` removed\n- [ ] All event types imported from `@pizzapi/protocol`\n\n## Technical Details\n\n### Files to Create/Modify\n- `packages/server/src/ws/namespaces/relay.ts` — full implementation (from placeholder)\n- `packages/server/src/ws/namespaces/viewer.ts` — full implementation\n- `packages/server/src/ws/namespaces/runner.ts` — full implementation\n- `packages/server/src/ws/namespaces/terminal.ts` — full implementation\n- `packages/server/src/ws/namespaces/hub.ts` — full implementation\n- `packages/server/src/ws/namespaces/auth.ts` — shared auth middleware factories\n\n### Files to Remove\n- `packages/server/src/routes/ws.ts`\n\n### Files to Modify\n- `packages/server/src/ws/relay.ts` — remove (replaced by namespace handlers)\n- `packages/server/src/index.ts` — remove old `websocket: { open, message, close }` references (keep during transition if Task 009 runs concurrently)\n\n### Port Logic From relay.ts\n1. **TUI registration flow** → `/relay` namespace `connection` + `register` event\n2. **Session event forwarding** → `/relay` `session_event` → `io.to(\"session:{id}\").emit()`\n3. **Heartbeat handling** → `/relay` `heartbeat` event\n4. **State snapshots** → `/relay` `session_active` event\n5. **Exec commands** (from viewer) → `/viewer` events → forwarded to TUI via `/relay`\n6. **Runner registration** → `/runner` namespace `connection` + auth\n7. **Terminal PTY** → `/terminal` namespace binary data events\n8. **Hub session feed** → `/hub` namespace with room-based broadcast\n\n### Auth Middleware Pattern\n```typescript\nrelayNamespace.use((socket, next) =\u003e {\n  const apiKey = socket.handshake.auth.apiKey;\n  if (!apiKey || !validateApiKey(apiKey)) return next(new Error(\"unauthorized\"));\n  socket.data.userId = lookupUserId(apiKey);\n  next();\n});\n```\n\n## Dependencies\n\n- [ ] Task 004 (registry must be Redis-backed before handlers can use it)\n\n## Effort Estimate\n\n- Size: L\n- Hours: 12\n- Parallel: false (core server logic, touches most server files)\n\n## Definition of Done\n\n- [ ] All 5 namespace handlers fully functional\n- [ ] Auth middleware validates correctly per namespace\n- [ ] Thinking duration tracking works in `/relay` handler\n- [ ] `routes/ws.ts` removed\n- [ ] All events typed with protocol package (no `any` casts)\n- [ ] `bun run build:server` succeeds\n- [ ] `bun run typecheck` passes\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:11Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:11Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.5","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:11Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.5","depends_on_id":"PizzaPi-b8h.4","type":"blocks","created_at":"2026-02-22T17:45:41Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.6","title":"Migrate UI WebSocket Connections to socket.io-client","description":"\n# Task: Migrate UI WebSocket Connections to socket.io-client\n\n## Description\n\nReplace all `new WebSocket(...)` usage in the React UI with `socket.io-client` namespace connections. Remove manual reconnection logic and leverage Socket.IO's built-in reconnection, typed events, and connection status.\n\n## Acceptance Criteria\n\n- [ ] `App.tsx` viewer connection uses `io(\"/viewer\", { query: { sessionId } })` instead of raw WS\n- [ ] `SessionSidebar.tsx` hub connection uses `io(\"/hub\")` instead of raw WS\n- [ ] `WebTerminal.tsx` terminal connection uses `io(\"/terminal\", { query: { terminalId } })` instead of raw WS\n- [ ] All manual reconnection/backoff code removed (~100+ lines across 3 files)\n- [ ] Connection status UI uses Socket.IO events (`connect`, `disconnect`, `reconnect_attempt`, `reconnect`)\n- [ ] All events typed via `@pizzapi/protocol` imports\n- [ ] `socket.io-client` added to UI package dependencies\n- [ ] UI bundle size increase \u003c 50KB gzipped (verified with build output)\n- [ ] Vite proxy config updated for Socket.IO transport negotiation if needed\n\n## Technical Details\n\n### Files to Modify\n- `packages/ui/package.json` — add `socket.io-client`\n- `packages/ui/src/App.tsx` — replace viewer WS with socket.io-client\n- `packages/ui/src/components/SessionSidebar.tsx` — replace hub WS with socket.io-client\n- `packages/ui/src/components/WebTerminal.tsx` — replace terminal WS with socket.io-client\n- `packages/ui/vite.config.ts` — update proxy for Socket.IO (if needed)\n\n### Migration Pattern (per component)\n```typescript\n// Before\nconst ws = new WebSocket(`${wsUrl}/ws/sessions/${sessionId}`);\nws.onmessage = (e) =\u003e { /* parse JSON, handle types */ };\nws.onclose = () =\u003e { /* manual reconnect with backoff */ };\n\n// After\nimport { io, Socket } from \"socket.io-client\";\nimport type { ViewerServerToClient, ViewerClientToServer } from \"@pizzapi/protocol\";\n\nconst socket: Socket\u003cViewerServerToClient, ViewerClientToServer\u003e = io(\"/viewer\", {\n  query: { sessionId },\n  withCredentials: true,\n});\nsocket.on(\"session_event\", (event) =\u003e { /* fully typed */ });\nsocket.on(\"disconnect\", (reason) =\u003e { /* auto-reconnect built in */ });\n```\n\n### Items to Remove\n- `reconnectTimeout` / `reconnectDelay` / exponential backoff variables\n- `scheduleReconnect()` functions\n- Manual `onclose` → `setTimeout` → `new WebSocket()` chains\n- `readyState` polling checks\n\n## Dependencies\n\n- [ ] Task 005 (server namespace handlers must be in place)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 8\n- Parallel: true (independent of Tasks 007, 008)\n\n## Definition of Done\n\n- [ ] All 3 UI components use socket.io-client\n- [ ] No remaining `new WebSocket` in UI source\n- [ ] Manual reconnection code removed\n- [ ] Events fully typed (no `any` casts)\n- [ ] `bun run build:ui` succeeds\n- [ ] `bun run typecheck` passes\n- [ ] Bundle size verified \u003c 50KB gzipped increase\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:12Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:12Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.6","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:11Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.6","depends_on_id":"PizzaPi-b8h.5","type":"blocks","created_at":"2026-02-22T17:45:42Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.7","title":"Migrate CLI remote.ts to socket.io-client","description":"\n# Task: Migrate CLI remote.ts to socket.io-client\n\n## Description\n\nReplace the raw WebSocket connection in `packages/cli/src/extensions/remote.ts` (1,769 lines) with `socket.io-client` using the `/relay` namespace. Remove manual reconnection with exponential backoff and the custom `seq`/`event_ack` mechanism, replacing them with Socket.IO's built-in reconnection and acknowledgements.\n\n## Acceptance Criteria\n\n- [ ] `remote.ts` connects to `/relay` namespace with `auth: { apiKey }` and `transports: [\"websocket\"]`\n- [ ] TUI registration handshake uses Socket.IO connection auth + initial emit (replacing `register` → `registered` flow)\n- [ ] Session events sent via typed `socket.emit()` calls instead of `ws.send(JSON.stringify(...))`\n- [ ] Manual reconnection with exponential backoff removed\n- [ ] `seq` counter and `event_ack` handling removed (use Socket.IO acks)\n- [ ] Remote exec commands (abort, set model, new session, compact, etc.) received via typed events\n- [ ] Provider usage and heartbeat events sent via typed events\n- [ ] All events typed via `@pizzapi/protocol` imports\n- [ ] `socket.io-client` added to CLI package dependencies\n\n## Technical Details\n\n### Files to Modify\n- `packages/cli/package.json` — add `socket.io-client`\n- `packages/cli/src/extensions/remote.ts` — major refactor of WS connection logic\n\n### Key Changes in remote.ts\n1. **Connection setup**: Replace `new WebSocket(relayUrl)` with `io(relayUrl + \"/relay\", { auth, transports: [\"websocket\"] })`\n2. **Registration**: Move from explicit `register` message to connection auth + `socket.on(\"connect\")` callback\n3. **Event sending**: Replace `ws.send(JSON.stringify({ type, ...payload }))` with `socket.emit(eventName, payload)`\n4. **Event receiving**: Replace `ws.onmessage` JSON parse + switch on `type` with `socket.on(eventName, handler)`\n5. **Reconnection**: Remove `scheduleReconnect()`, backoff timers — Socket.IO handles this\n6. **Acks**: Replace `seq`/`event_ack` with Socket.IO callback acks where delivery confirmation needed\n7. **Disconnect handling**: Use `socket.on(\"disconnect\")` and `socket.on(\"reconnect\")` events\n\n### Estimated Line Reduction\n- ~80 lines of reconnection logic removed\n- ~30 lines of seq/ack tracking removed\n- ~20 lines of JSON serialization simplified\n- Net: ~100-130 lines removed\n\n## Dependencies\n\n- [ ] Task 005 (server `/relay` namespace handler must be in place)\n\n## Effort Estimate\n\n- Size: M\n- Hours: 8\n- Parallel: true (independent of Tasks 006, 008)\n\n## Definition of Done\n\n- [ ] CLI connects to relay via Socket.IO `/relay` namespace\n- [ ] All session events flow correctly (register, events, heartbeat, state)\n- [ ] Remote exec commands work (abort, set model, new session, etc.)\n- [ ] No remaining raw `WebSocket` usage in remote.ts\n- [ ] Manual reconnection code removed\n- [ ] `bun run build:cli` succeeds\n- [ ] `bun run typecheck` passes\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:12Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:12Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.7","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:12Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.7","depends_on_id":"PizzaPi-b8h.5","type":"blocks","created_at":"2026-02-22T17:45:42Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.8","title":"Migrate Runner daemon.ts to socket.io-client","description":"\n# Task: Migrate Runner daemon.ts to socket.io-client\n\n## Description\n\nReplace the raw WebSocket connection in `packages/cli/src/runner/daemon.ts` (975 lines) with `socket.io-client` using the `/runner` namespace. Remove manual reconnection logic and use typed events for runner registration, session management, and skill commands.\n\n## Acceptance Criteria\n\n- [ ] `daemon.ts` connects to `/runner` namespace with `auth: { apiKey, runnerId, runnerSecret }` and `transports: [\"websocket\"]`\n- [ ] Runner registration uses Socket.IO connection auth (replacing manual `register` message)\n- [ ] `new_session`, `kill_session`, skill commands received via typed events\n- [ ] Manual reconnection with exponential backoff removed\n- [ ] Runner heartbeat and usage data sent via typed events\n- [ ] All events typed via `@pizzapi/protocol` imports\n- [ ] `socket.io-client` already in CLI package (shared with remote.ts from Task 007)\n\n## Technical Details\n\n### Files to Modify\n- `packages/cli/src/runner/daemon.ts` — refactor WS connection logic\n\n### Key Changes in daemon.ts\n1. **Connection setup**: Replace `new WebSocket(...)` with `io(relayUrl + \"/runner\", { auth: { apiKey, runnerId, runnerSecret }, transports: [\"websocket\"] })`\n2. **Registration**: Move from explicit `register` message to connection auth + `socket.on(\"connect\")`\n3. **Command handling**: Replace `ws.onmessage` switch on `type` with `socket.on(\"new_session\", ...)`, `socket.on(\"kill_session\", ...)`, etc.\n4. **Reconnection**: Remove manual backoff — Socket.IO handles this\n5. **Status reporting**: Replace `ws.send(JSON.stringify(...))` with `socket.emit(eventName, payload)`\n\n### Estimated Line Reduction\n- ~60 lines of reconnection logic removed\n- ~15 lines of JSON serialization simplified\n- Net: ~60-75 lines removed\n\n## Dependencies\n\n- [ ] Task 005 (server `/runner` namespace handler must be in place)\n\n## Effort Estimate\n\n- Size: S\n- Hours: 5\n- Parallel: true (independent of Tasks 006, 007)\n\n## Definition of Done\n\n- [ ] Runner daemon connects via Socket.IO `/runner` namespace\n- [ ] Registration, session spawning, and skill commands work correctly\n- [ ] No remaining raw `WebSocket` usage in daemon.ts\n- [ ] Manual reconnection code removed\n- [ ] `bun run build:cli` succeeds\n- [ ] `bun run typecheck` passes\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:13Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:13Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.8","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:12Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.8","depends_on_id":"PizzaPi-b8h.5","type":"blocks","created_at":"2026-02-22T17:45:43Z","created_by":"Jordan Pizza","metadata":"{}"}]}
{"id":"PizzaPi-b8h.9","title":"Backward Compatibility Shim for Raw WS Clients","description":"\n# Task: Backward Compatibility Shim for Raw WS Clients\n\n## Description\n\nKeep the existing raw WebSocket `/ws/sessions` endpoint alive alongside Socket.IO for 1-2 releases so older CLI versions (pre-migration) can still connect. The server detects the protocol on connection and routes to either the legacy handler or Socket.IO namespace.\n\n## Acceptance Criteria\n\n- [ ] Raw WS `/ws/sessions` endpoint still accepts connections from old CLI versions\n- [ ] Server detects whether a connection is Socket.IO (EIO protocol) or raw WS\n- [ ] Legacy connections route to a thin compatibility handler that bridges to the new registry\n- [ ] New Socket.IO connections route to namespace handlers as normal\n- [ ] Both connection types can coexist on the same server instance\n- [ ] Legacy handler reads/writes to the same Redis-backed state as Socket.IO handlers\n- [ ] Console warning logged when legacy client connects: \"Legacy WS client detected, consider upgrading\"\n- [ ] Feature flag or config option to disable legacy support when ready\n\n## Technical Details\n\n### Approach\n- Socket.IO uses the `/socket.io/` path prefix by default for its HTTP handshake\n- Raw WS connections to `/ws/sessions` use the original Bun `websocket` handler\n- Keep the Bun.serve `websocket: { open, message, close }` handler but scope it to legacy paths only\n- Legacy handler calls into the new Redis-backed registry functions (same data layer)\n\n### Files to Modify\n- `packages/server/src/index.ts` — keep Bun WS handler for legacy paths, Socket.IO for `/socket.io/`\n- `packages/server/src/routes/ws.ts` — keep but mark as deprecated, simplify to only handle `/ws/sessions`\n\n### Files to Create\n- `packages/server/src/ws/legacy-shim.ts` — thin adapter bridging old `{ type, ...payload }` messages to new registry calls\n\n### Deprecation Plan\n- Log warning on every legacy connection\n- Add `PIZZAPI_LEGACY_WS=true|false` env var (default `true` for 1-2 releases)\n- After transition period, set default to `false`, then remove entirely\n\n## Dependencies\n\n- [ ] Task 005 (namespace handlers must be in place for Socket.IO path)\n\n## Effort Estimate\n\n- Size: S\n- Hours: 4\n- Parallel: true (independent of client migrations)\n\n## Definition of Done\n\n- [ ] Old CLI version can connect via raw WS and function correctly\n- [ ] New CLI version connects via Socket.IO and functions correctly\n- [ ] Both work simultaneously on the same server\n- [ ] Deprecation warning logged for legacy connections\n- [ ] Feature flag to disable legacy support works\n- [ ] `bun run build:server` succeeds\n","status":"open","priority":2,"issue_type":"task","owner":"10016234+Pizzaface@users.noreply.github.com","created_at":"2026-02-22T22:45:13Z","created_by":"Jordan Pizza","updated_at":"2026-02-22T22:45:13Z","labels":["epic:socketio-migration","task"],"dependencies":[{"issue_id":"PizzaPi-b8h.9","depends_on_id":"PizzaPi-b8h","type":"parent-child","created_at":"2026-02-22T17:45:13Z","created_by":"Jordan Pizza","metadata":"{}"},{"issue_id":"PizzaPi-b8h.9","depends_on_id":"PizzaPi-b8h.5","type":"blocks","created_at":"2026-02-22T17:45:43Z","created_by":"Jordan Pizza","metadata":"{}"}]}
