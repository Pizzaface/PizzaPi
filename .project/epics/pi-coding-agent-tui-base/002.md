---
name: Remote Session Sharing
status: open
created: 2026-02-19T17:20:07Z
updated: 2026-02-19T17:20:07Z
beads_id: [Will be updated when synced to Beads]
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Remote Session Sharing

## Description

Add `/share` to the PizzaPi TUI: when invoked, the active agent session is streamed live to a browser via a WebSocket relay. Implemented as a pi-coding-agent extension registered at startup. Also upgrades `packages/server` with a `/ws/sessions` WebSocket handler that acts as the relay between the local TUI and browser clients.

## Acceptance Criteria

- [ ] `packages/cli/src/extensions/remote.ts` registers a `/share` slash command via `pi.registerCommand()`
- [ ] Invoking `/share` in the TUI connects to the relay server and prints a shareable URL
- [ ] Browser clients connecting to the relay URL receive live session output (text diffs)
- [ ] Browser input (keystrokes) is forwarded back to the agent session
- [ ] `packages/server/src/ws/` contains relay and session registry logic
- [ ] WebSocket endpoint: `GET /ws/sessions/:sessionId` (Bun native upgrade)
- [ ] JWT auth: relay server issues a short-lived token when `/share` is called; browser must present it
- [ ] Read-only mode by default; collaborative mode opt-in via `/share --collab`
- [ ] Relay server gracefully handles TUI disconnect (session ended) and notifies browser clients

## Technical Details

- Extension registered via SDK: pass extension to `createAgentSession()` at startup in `packages/cli/src/index.ts`
- Output streaming: subscribe to `session.subscribe()` events for `message_update` and `tool_call` events; forward serialized diffs over WebSocket to relay
- Relay server: Bun native WebSocket in `packages/server/src/index.ts` — add `websocket` handler and upgrade logic to existing `Bun.serve()` call (no new server needed)
- Session registry (`packages/server/src/ws/registry.ts`): Map of sessionId → Set of connected browser WebSocket clients
- JWT: use `jose` or Bun's built-in `crypto` for HS256 token generation/verification; token payload: `{ sessionId, mode: "read" | "collab", exp }`
- Files affected:
  - `packages/cli/src/index.ts` (register extension)
  - `packages/cli/src/extensions/remote.ts` (new)
  - `packages/server/src/index.ts` (add WebSocket upgrade)
  - `packages/server/src/ws/registry.ts` (new)
  - `packages/server/src/ws/relay.ts` (new)
  - `packages/server/package.json` (add jose if needed)

## Dependencies

- [ ] Task 001 complete (CLI scaffold must exist before extension can be wired)
- [ ] `packages/server` running locally for relay

## Effort Estimate

- Size: M
- Hours: 8–12
- Parallel: false

## Definition of Done

- [ ] Code implemented
- [ ] Manual test: `pizzapi` → `/share` → open URL in browser → see live session output
- [ ] Manual test: type in browser (collab mode) → agent receives message and responds
- [ ] JWT token rejected if tampered (403 on WebSocket upgrade)
- [ ] TUI disconnect → browser shows "Session ended" message
- [ ] Code reviewed
