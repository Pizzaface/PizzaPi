---
name: Remote Runner Daemon
status: open
created: 2026-02-19T17:20:07Z
updated: 2026-02-19T17:20:07Z
beads_id: [Will be updated when synced to Beads]
depends_on: [001, 002]
parallel: false
conflicts_with: []
---

# Task: Remote Runner Daemon

## Description

Implement `pizzapi runner` — a background WebSocket daemon that allows the PizzaPi web UI to spawn new agent sessions on a remote host. The daemon connects to the relay server (packages/server) and registers itself as an available runner. When the web UI requests a new session, the daemon spawns a `createAgentSession()` instance and bridges its output to the browser via the relay.

## Acceptance Criteria

- [ ] `pizzapi runner` sub-command starts a background-capable WebSocket daemon
- [ ] Daemon authenticates to the relay server with `PIZZAPI_RUNNER_TOKEN` env var (bearer token)
- [ ] Web UI can list available runners via relay (`GET /api/runners`)
- [ ] Web UI can request a new session on a runner (`POST /ws/sessions` with `{ runner_id, ... }`)
- [ ] Daemon spawns `createAgentSession()` and streams output back through the relay to the browser
- [ ] Daemon supports: `new_session`, `attach_session`, `list_sessions`, `kill_session` commands
- [ ] Graceful shutdown: active sessions are terminated cleanly when daemon exits
- [ ] Runner registry in `packages/server` tracks connected runners and their active sessions

## Technical Details

- `pizzapi runner` mode detected in `packages/cli/src/index.ts` via `process.argv`; delegates to `packages/cli/src/runner/daemon.ts`
- Daemon connects to relay server via WebSocket (`/ws/runner`), authenticates with bearer token in first message
- Session spawning: use `createAgentSession()` from `@mariozechner/pi-coding-agent` SDK in non-TUI (headless/JSON) mode so it runs without a terminal
- Output bridging (`packages/cli/src/runner/bridge.ts`): subscribe to session events, serialize, forward to relay; relay forwards to browser clients in the session's viewer set
- Runner registry added to `packages/server/src/ws/registry.ts`: Map of runnerId → { ws, sessions: Map }
- New relay endpoint: `GET /ws/runner` for daemon connections (separate from browser `/ws/sessions/:id`)
- New REST endpoint: `GET /api/runners` returns list of connected runners with session counts
- Files affected:
  - `packages/cli/src/index.ts` (add runner mode dispatch)
  - `packages/cli/src/runner/daemon.ts` (new)
  - `packages/cli/src/runner/bridge.ts` (new)
  - `packages/server/src/index.ts` (add /ws/runner upgrade, /api/runners endpoint)
  - `packages/server/src/ws/registry.ts` (extend with runner registry)

## Dependencies

- [ ] Task 001 complete (CLI scaffold and createAgentSession() wiring)
- [ ] Task 002 complete (server WebSocket infrastructure and relay logic)
- [ ] `PIZZAPI_RUNNER_TOKEN` env var set on the host running the daemon

## Effort Estimate

- Size: M
- Hours: 8–12
- Parallel: false

## Definition of Done

- [ ] Code implemented
- [ ] Manual test: `PIZZAPI_RUNNER_TOKEN=test pizzapi runner` connects to local relay
- [ ] Manual test: web UI lists the connected runner
- [ ] Manual test: web UI creates new session → agent session spawned → output visible in browser
- [ ] `kill_session` terminates session cleanly (no orphaned processes)
- [ ] Daemon reconnects to relay on disconnect (with exponential backoff)
- [ ] Code reviewed
